<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskMaster Pro</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" href="./favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="./icons/android-launchericon-192-192.png">
    <meta name="theme-color" content="#667eea">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <style>
        :root {
            --bg-grad-start: #667eea; --bg-grad-end: #764ba2;
            --header-grad-start: #4facfe; --header-grad-end: #00f2fe;
            --text-light: white; --text-dark: #2d3748; --text-muted: #64748b;
            --bg-main: rgba(255, 255, 255, 0.95); --bg-secondary: #f8fafc; --bg-card: white;
            --border-color: #e2e8f0; --accent-color: #4facfe;
            --accent-color-default: #4facfe; /* NUEVO: Color de acento por defecto para el tema claro */
            --shadow-light: rgba(0, 0, 0, 0.08); --shadow-heavy: rgba(0, 0, 0, 0.1);
            --notification-grad-start: #667eea; --notification-grad-end: #764ba2;
            --pomodoro-active-bg: color-mix(in srgb, var(--accent-color) 15%, transparent);
            --toast-success-bg: #48bb78; --toast-error-bg: #f56565; --toast-achievement-bg: linear-gradient(135deg, #fdd835, #f57f17);
            --prio-high: #f56565; --prio-medium: #ed8936; --prio-low: #48bb78;
            --font-family-sans-serif: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-family-serif: Georgia, 'Times New Roman', Times, serif;
            --font-family-mono: 'Courier New', Courier, monospace;
        }
        [data-theme="dark"] {
            --bg-grad-start: #232526; --bg-grad-end: #414345; --header-grad-start: #434343; --header-grad-end: #000000;
            --text-light: #f7fafc; --text-dark: #e2e8f0; --text-muted: #a0aec0;
            --bg-main: rgba(26, 32, 44, 0.95); --bg-secondary: #2d3748; --bg-card: #4a5568; --border-color: #4a5568;
            --accent-color: #63b3ed;
            --accent-color-default: #63b3ed; /* NUEVO: Color de acento por defecto para el tema oscuro */
            --shadow-light: rgba(255, 255, 255, 0.05); --shadow-heavy: rgba(0, 0, 0, 0.2);
            --notification-grad-start: #89f7fe; --notification-grad-end: #66a6ff;
        }
        [data-theme="ocean"] {
            --bg-grad-start: #00c6ff; --bg-grad-end: #0072ff; --header-grad-start: #0052D4; --header-grad-end: #4364F7;
            --text-dark: #1A202C; --accent-color: #0072ff; --accent-color-default: #0072ff;
        }
        [data-theme="forest"] {
            --bg-grad-start: #134E5E; --bg-grad-end: #71B280; --header-grad-start: #0f3443; --header-grad-end: #34e89e;
            --text-dark: #f7fafc; --text-muted: #a0aec0; --bg-main: #2d3748e0; --bg-secondary: #4a5568; --bg-card: #2d3748;
            --accent-color: #34e89e; --accent-color-default: #34e89e;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: var(--font-family-sans-serif); background: linear-gradient(135deg, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%); color: var(--text-dark); min-height: 100vh; transition: background 0.3s ease, color 0.3s ease, font-family 0.3s ease; }
        .app-wrapper { display: flex; flex-direction: column; height: 100%; }
        .app-content { flex-grow: 1; overflow-y: auto; }
        .container { max-width: 1200px; margin: 20px auto; background: var(--bg-main); border-radius: 20px; box-shadow: 0 20px 40px var(--shadow-heavy); overflow: visible; /* Permitir que los hovers se vean */ transition: background 0.3s ease; }
        .header { background: linear-gradient(135deg, var(--header-grad-start) 0%, var(--header-grad-end) 100%); padding: 20px 30px; text-align: center; color: var(--text-light); transition: all 0.3s ease; border-bottom: 1px solid transparent; position: relative; z-index: 100; }
        .header-buttons { position: absolute; top: 50%; transform: translateY(-50%); right: 20px; display: flex; align-items: center; gap: 10px; }
        .header-btn { background: rgba(255,255,255,.2); color: #fff; border: none; width: 45px; height: 45px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; transition: all .3s ease; display: flex; align-items: center; justify-content: center; }
        .header-btn:hover { background: rgba(255,255,255,.3); transform: translateY(-3px) rotate(10deg); }
        .header-btn.active { background: rgba(255,255,255,.4); }
        .streak-counter { display: flex; align-items: center; gap: 8px; font-weight: 600; background: rgba(255,255,255,.2); padding: 5px 15px; border-radius: 20px; color: white; font-size: 1rem; }
        .main-content { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; padding: 30px; }
        @media (max-width: 1024px) { .main-content { grid-template-columns: 1fr; } }
        .task-section, .stats, .calendar-section { transition: opacity 0.3s ease, filter 0.3s ease; }
        body.focus-mode .app-wrapper > *:not(.sidebar), body.focus-mode .sidebar > *:not(.pomodoro) { opacity: 0.1; filter: blur(4px); pointer-events: none; }
        body.focus-mode .pomodoro { z-index: 10; transform: scale(1.05); }
        .task-controls { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .task-controls input, .task-controls select { padding: 12px; border: 2px solid var(--border-color); background-color: var(--bg-secondary); color: var(--text-dark); border-radius: 8px; font-size: 1rem; flex-grow: 1; transition: border-color 0.3s, background-color 0.3s; }
        #tasksList { margin-top: 20px; position: relative; }
        .task-item { transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94); cursor: grab; animation: slide-in 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .task-item.slide-out { transform: translateX(50px) scale(0.9); opacity: 0; }
        .task-item.pomodoro-active { background-color: var(--pomodoro-active-bg); border-left-color: var(--accent-color) !important; transform: scale(1.02); }
        .task-item.dragging { opacity: 0.5; background: var(--accent-color); cursor: grabbing; }
        .task-item.task-overdue { border-left-color: var(--prio-high) !important; }
        .task-item.task-due-today { border-left-color: var(--prio-medium) !important; }
        .view-hidden { display: none !important; }
        .calendar-section { background: var(--bg-card); border-radius: 15px; padding: 25px; box-shadow: 0 4px 15px var(--shadow-light); }
        .fc { --fc-border-color: var(--border-color); --fc-today-bg-color: var(--pomodoro-active-bg); }
        .fc .fc-button { background: linear-gradient(135deg, var(--header-grad-start), var(--header-grad-end)); border: none; color: white; text-transform: capitalize; transition: all 0.2s ease; }
        .fc .fc-button:hover { filter: brightness(1.1); }
        .fc .fc-button-primary:disabled { background: var(--border-color); }
        .fc .fc-button-primary:not(:disabled).fc-button-active, .fc .fc-button-primary:not(:disabled):active { filter: brightness(0.9); }
        .fc .fc-col-header-cell-cushion, .fc .fc-daygrid-day-number { color: var(--text-dark); text-decoration: none; }
        .fc-event { font-size: 0.8rem; border-width: 2px !important; cursor: grab; }
        .fc-event:hover { filter: brightness(1.1); }
        h1{font-size:2.5rem}label{font-weight:600;color:var(--text-muted);margin-bottom:5px;display:block;}.form-row,.stats{display:grid}.stats{grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:20px;padding:30px;background:var(--bg-secondary)}.stat-card{background:var(--bg-card);padding:20px;border-radius:15px;text-align:center;box-shadow:0 4px 15px var(--shadow-light);transition:all .3s ease}.stat-card:hover{transform:translateY(-5px)}.stat-number{font-size:2.5rem;font-weight:700;color:var(--accent-color)}.stat-label{color:var(--text-muted);font-size:.9rem}.task-section,.sidebar>div{background:var(--bg-card);border-radius:15px;padding:25px;box-shadow:0 4px 15px var(--shadow-light)}.section-title{font-size:1.5rem;color:var(--text-dark);margin-bottom:20px;padding-bottom:10px;border-bottom:2px solid var(--border-color)}.notification{background:linear-gradient(135deg,var(--notification-grad-start) 0%,var(--notification-grad-end) 100%);color:var(--text-light);padding:15px;border-radius:10px;margin-bottom:10px;text-align:center;font-weight:600; animation: fadeInDown 0.5s ease both;}.task-form{display:grid;gap:15px;margin-bottom:25px}.task-form input[type="text"],.task-form input[type="date"],.task-form select{width:100%;padding:12px;border:2px solid var(--border-color);background-color:var(--bg-secondary);color:var(--text-dark);border-radius:8px;font-size:1rem;transition:border-color .3s,background-color .3s}.task-form input:focus,.task-form select:focus{outline:none;border-color:var(--accent-color)}.form-row{grid-template-columns:1fr 1fr;gap:15px}.form-group{display:flex;flex-direction:column}.form-group.full-width{grid-column:1/-1}.task-item{background:var(--bg-secondary);padding:20px;border-radius:12px;margin-bottom:15px;border-left:5px solid #cbd5e0}.task-item:hover{transform:translateX(5px);box-shadow:0 4px 15px var(--shadow-heavy)}.task-header,.task-actions{display:flex;align-items:flex-start}.task-header{justify-content:space-between;margin-bottom:10px}.task-title{font-size:1.1rem;font-weight:600;color:var(--text-dark);margin-bottom:5px}.task-meta{display:flex;gap:15px;align-items:center;font-size:.9rem;color:var(--text-muted);flex-wrap:wrap}.task-actions{gap:5px}.btn{padding:8px 16px;border:none;border-radius:8px;cursor:pointer;font-weight:600;transition:all .3s ease;font-size:.9rem}.btn-primary{background:linear-gradient(135deg,var(--header-grad-start) 0%,var(--header-grad-end) 100%);color:#fff}.btn-icon{width:35px;height:35px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;background-color:transparent;color:var(--text-muted);}.btn-icon:hover{background-color:var(--border-color);transform:scale(1.1) translateY(-2px);}.sidebar{display:flex;flex-direction:column;gap:25px}.pomodoro-timer{font-size:2.5rem;font-weight:700;text-align:center;color:var(--text-dark);margin:10px 0;transition: color 0.3s;}.pomodoro-timer.finished{animation:blinker 1s linear 3;}.pomodoro-cycle-title{text-align:center;font-weight:600;color:var(--text-muted);margin-bottom:10px}.pomodoro-controls{display:flex;justify-content:center;gap:10px;margin-top:20px}.pomodoro-btn{width:50px;height:50px;border-radius:50%;border:none;font-size:1.2rem;cursor:pointer;color:#fff;transition:all .3s ease;display:flex;align-items:center;justify-content:center}.pomodoro-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px var(--shadow-heavy)}.play-btn{background:#48bb78}.pause-btn{background:#ed8936}.reset-btn{background:#e53e3e}.skip-btn{background:#4facfe}.modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);backdrop-filter:blur(5px);z-index:1000;animation:fadeIn .3s ease}.modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--bg-card);color:var(--text-dark);border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.2);max-width:800px;width:90%;overflow:hidden;animation:slideInModal .3s ease}.modal-header{background:linear-gradient(135deg,#f56565 0%,#e53e3e 100%);color:#fff;padding:20px;text-align:center}.modal-header.settings,.modal-header.edit,.modal-header.dashboard,.modal-header.stats{background:linear-gradient(135deg,var(--header-grad-start) 0%,var(--header-grad-end) 100%)}.modal-body{padding:25px;max-height:70vh;overflow-y:auto}.modal-body p{color:var(--text-muted);font-size:1rem;margin-bottom:25px;line-height:1.5;text-align:center}.modal-actions{display:flex;gap:10px;justify-content:flex-end;padding:20px 25px;border-top:1px solid var(--border-color)}.modal-btn{min-width:100px; padding: 10px 15px;}.completed .task-title{text-decoration:line-through; color: var(--text-muted)}.empty-state{text-align:center;padding:40px;color:var(--text-muted);}.empty-state svg{max-width:200px; margin-bottom:20px; opacity: 0.7;}.empty-state h4{font-size:1.2rem; color:var(--text-dark); margin-bottom:8px;}@keyframes fadeIn{from{opacity:0}to{opacity:1}}@keyframes slideInModal{from{opacity:0;transform:translate(-50%,-60%)}to{opacity:1;transform:translate(-50%,-50%)}}@keyframes slide-in{from{opacity:0;transform:translateX(-30px)}to{opacity:1;transform:translateX(0)}}@keyframes fadeInDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
        #editTaskModal .modal, #settingsModal .modal, #deleteModal .modal { max-width: 500px; }
        .modal-body .form-group select, .modal-body .form-group input, .modal-body .form-group textarea { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--bg-secondary); color: var(--text-dark); }
        .modal-body .form-group textarea { resize: vertical; min-height: 100px; }
        .modal-data-actions { display: flex; gap: 10px; margin-top: 10px; }
        .modal-data-actions .modal-btn, .modal-data-actions .import-label { flex: 1; text-align: center; display: flex; align-items: center; justify-content: center; background-color: var(--bg-secondary); color: var(--text-dark); border: 1px solid var(--border-color); }
        .modal-data-actions .import-label { cursor: pointer; }
        .modal-data-actions .modal-btn:hover, .modal-data-actions .import-label:hover { background-color: var(--border-color); }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--toast-success-bg); color: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s, bottom 0.3s; }
        .toast.show { opacity: 1; visibility: visible; bottom: 40px; }
        .toast.error { background-color: var(--toast-error-bg); }
        .toast.achievement { background: var(--toast-achievement-bg); }
        .chart-container { margin-bottom: 40px; }
        .chart-container h4 { text-align: center; color: var(--text-dark); margin-bottom: 15px; }
        .achievements-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px; text-align: center; }
        .achievement-item { display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .achievement-icon { font-size: 2.5rem; color: var(--border-color); transition: all 0.3s ease; }
        .achievement-item.unlocked .achievement-icon { color: #fdd835; transform: scale(1.1); }
        .achievement-item .ach-title { font-size: 0.9rem; font-weight: 600; color: var(--text-muted); }
        .achievement-item.unlocked .ach-title { color: var(--text-dark); }
        .btn-icon.pomodoro-start-btn { color: var(--prio-medium); }
        .btn-icon.edit-btn { color: var(--accent-color); }
        .btn-icon.delete-btn { color: var(--prio-high); }
        .btn-icon.complete-btn { position: relative; overflow: hidden; }
        .btn-icon.complete-btn .fa-circle-check { transition: transform 0.3s ease, color 0.3s ease; }
        .btn-icon.complete-btn.is-completed .fa-circle-check { color: var(--prio-low); transform: scale(1.2) rotate(360deg); }
        .btn-icon.complete-btn.is-pending .fa-circle-check { color: var(--text-muted); }
        .task-subtasks { margin-top: 15px; border-top: 1px solid var(--border-color); padding-top: 15px; display: flex; flex-direction: column; gap: 8px; }
        .task-subtask-item { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; }
        .task-subtask-item input[type="checkbox"] { accent-color: var(--accent-color); width: 16px; height: 16px; cursor: pointer; }
        .task-subtask-item label { font-weight: normal; color: var(--text-dark); transition: all 0.2s; }
        .task-subtask-item.completed label { text-decoration: line-through; color: var(--text-muted); }
        .task-progress { width: 100%; background-color: var(--border-color); border-radius: 5px; height: 6px; margin-top: 15px; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background-color: var(--accent-color); transition: width 0.3s ease; }
        .footer-copyright { text-align: center; padding: 25px 20px 20px 20px; color: var(--text-muted); font-size: 0.9rem; }
        .goals-section { margin-bottom: 25px; }
        .goal-progress { margin-bottom: 15px; }
        .goal-progress label { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: 600; }
        .progress-bar-container { background-color: var(--border-color); border-radius: 10px; height: 20px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: linear-gradient(135deg, var(--accent-color), color-mix(in srgb, var(--accent-color) 70%, black)); transition: width 0.5s ease; text-align: center; color: white; font-size: 0.8rem; line-height: 20px; border-radius: 10px; }
        .detailed-stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .color-picker-wrapper { display: flex; align-items: center; gap: 10px; }
        .color-picker-wrapper input[type="color"] { width: 40px; height: 40px; border: none; padding: 0; cursor: pointer; border-radius: 8px; background-color: transparent; }
        #resetAccentColor { font-size: 0.9rem; padding: 5px 10px; }
        @keyframes blinker { 50% { opacity: 0.2; } }
        @media (max-width: 768px) { .task-controls { flex-direction: column; } .form-row { grid-template-columns: 1fr; } .header-buttons { position: static; transform: none; justify-content: center; padding-top: 15px; } .header h1 { font-size: 2rem; } }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <div class="header">
            <h1 data-translate-key="title"></h1>
            <p data-translate-key="subtitle"></p>
            <div class="header-buttons">
                <div id="streakCounter" class="streak-counter" style="display: none;"></div>
                <button id="listViewBtn" class="header-btn active" title="Vista de Lista (L)" aria-label="Cambiar a vista de lista"><i class="fa-solid fa-list-ul"></i></button>
                <button id="calendarViewBtn" class="header-btn" title="Vista de Calendario (C)" aria-label="Cambiar a vista de calendario"><i class="fa-solid fa-calendar-days"></i></button>
                <button id="statsBtn" class="header-btn" title="Metas y Estad√≠sticas (M)" aria-label="Ver metas y estad√≠sticas"><i class="fa-solid fa-bullseye"></i></button>
                <button id="dashboardBtn" class="header-btn" title="Dashboard de Productividad (D)" aria-label="Ver dashboard de productividad"><i class="fa-solid fa-chart-line"></i></button>
                <button id="settingsBtn" class="header-btn" title="Configuraci√≥n (S)" aria-label="Abrir configuraci√≥n"><i class="fa-solid fa-gear"></i></button>
            </div>
        </div>

        <div class="app-content">
            <div class="container">
                <div class="stats" id="statsContainer"></div>

                <div class="main-content">
                    <div id="list-view-section" class="task-section">
                        <div id="taskFormContainer"></div>
                        <div class="task-controls">
                            <input type="search" id="searchInput" data-translate-key-placeholder="placeholder_search" title="Atajo: F">
                            <select id="filterCategory" aria-label="Filtrar por categor√≠a"></select>
                        </div>
                        <div id="tasksList"></div>
                    </div>
                    <div id="calendar-view-section" class="calendar-section view-hidden">
                        <div id="calendar"></div>
                    </div>

                    <div class="sidebar">
                        <div class="notifications">
                            <h3 class="section-title" data-translate-key="title_notifications"></h3>
                            <div id="welcomeNotification" class="notification"></div>
                        </div>
                        <div class="pomodoro">
                            <h3 class="section-title" data-translate-key="title_pomodoro"></h3>
                            <div id="pomodoroTaskTitle" style="text-align: center; color: var(--text-muted); margin-bottom: 10px; font-weight: 500; min-height: 20px;"></div>
                            <div id="pomodoroCycleTitle" class="pomodoro-cycle-title"></div>
                            <div id="pomodoroTimer" class="pomodoro-timer">25:00</div>
                            <div class="pomodoro-controls">
                                <button class="pomodoro-btn play-btn" id="playBtn" title="Iniciar" aria-label="Iniciar Pomodoro"><i class="fa-solid fa-play"></i></button>
                                <button class="pomodoro-btn pause-btn" id="pauseBtn" title="Pausar" aria-label="Pausar Pomodoro"><i class="fa-solid fa-pause"></i></button>
                                <button class="pomodoro-btn reset-btn" id="resetBtn" title="Reiniciar" aria-label="Reiniciar Pomodoro"><i class="fa-solid fa-stop"></i></button>
                                <button class="pomodoro-btn skip-btn" id="skipBtn" title="Saltar" aria-label="Saltar ciclo Pomodoro"><i class="fa-solid fa-forward"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="footer-copyright">
                    Copyright ¬© 2025 LUFTMANDMAURICIO
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODALS -->
    <div class="modal-overlay" id="deleteModal"><div class="modal"><div class="modal-header"><h3></h3></div><div class="modal-body"><p></p></div><div class="modal-actions"><button id="cancelDelete" class="modal-btn"></button><button id="confirmDelete" class="modal-btn" style="background-color: #e53e3e; color: white;"></button></div></div></div>
    <div class="modal-overlay" id="editTaskModal"><div class="modal"><div class="modal-header edit"><h3></h3></div><div class="modal-body"><div class="form-group"><label data-translate-key="label_task"></label><input type="text" id="editTaskTitle"></div><div class="form-group"><label data-translate-key="label_notes"></label><textarea id="editTaskNotes" data-translate-key-placeholder="placeholder_notes"></textarea></div><div class="form-group"><label data-translate-key="label_subtasks"></label><div id="editSubtaskList"></div><input type="text" id="newSubtaskInput" data-translate-key-placeholder="placeholder_subtask"></div></div><div class="modal-actions"><button id="cancelEdit" class="modal-btn"></button><button id="saveEdit" class="modal-btn" style="background-color: var(--accent-color); color: white;"></button></div></div></div>
    <div class="modal-overlay" id="settingsModal">
         <div class="modal">
            <div class="modal-header settings"><h3 data-translate-key="settings_title"></h3></div>
            <div class="modal-body" style="text-align: left;">
                <div style="margin-bottom: 20px;"><h4><i class="fa-solid fa-wand-magic-sparkles"></i> <span data-translate-key="settings_ui_customization"></span></h4>
                    <div class="form-group"><label for="fontSelector" data-translate-key="settings_font"></label><select id="fontSelector"><option value="sans-serif" data-translate-key="font_sans_serif"></option><option value="serif" data-translate-key="font_serif"></option><option value="mono" data-translate-key="font_mono"></option></select></div>
                    <div class="form-group"><label for="accentColorPicker" data-translate-key="settings_accent_color"></label><div class="color-picker-wrapper"><input type="color" id="accentColorPicker" aria-label="Selector de color de acento"> <span id="accentColorValue"></span><button id="resetAccentColor" class="btn modal-btn" data-translate-key="btn_reset"></button></div></div>
                </div>
                <div style="border-top: 1px solid var(--border-color); padding-top: 15px; margin-top: 15px;"><h4><i class="fa-solid fa-sliders"></i> <span data-translate-key="settings_general"></span></h4>
                    <div class="form-group"><label for="themeSelector" data-translate-key="settings_theme"></label><select id="themeSelector"><option value="light" data-translate-key="theme_light"></option><option value="dark" data-translate-key="theme_dark"></option><option value="ocean" data-translate-key="theme_ocean"></option><option value="forest" data-translate-key="theme_forest"></option></select></div>
                    <div class="form-group"><label for="languageSelector" data-translate-key="settings_language"></label><select id="languageSelector"><option value="es">Espa√±ol</option><option value="en">English</option></select></div>
                    <div class="form-group"><label for="soundThemeSelector" data-translate-key="settings_sound_theme"></label><select id="soundThemeSelector"><option value="classic" data-translate-key="sound_classic"></option><option value="digital" data-translate-key="sound_digital"></option><option value="relaxing" data-translate-key="sound_relaxing"></option></select></div>
                </div>
                <div style="border-top: 1px solid var(--border-color); padding-top: 15px; margin-top: 20px;"><h4><i class="fa-solid fa-stopwatch"></i> <span data-translate-key="settings_pomodoro"></span></h4><div class="form-row"><div class="form-group"><label for="pomodoroWork" data-translate-key="pomo_work_duration"></label><input type="number" id="pomodoroWork" min="1"></div><div class="form-group"><label for="pomodoroShortBreak" data-translate-key="pomo_short_break_duration"></label><input type="number" id="pomodoroShortBreak" min="1"></div></div><div class="form-group"><label for="pomodoroLongBreak" data-translate-key="pomo_long_break_duration"></label><input type="number" id="pomodoroLongBreak" min="1"></div></div>
                <div style="border-top: 1px solid var(--border-color); padding-top: 15px; margin-top: 20px;"><h4><i class="fa-solid fa-trophy"></i> <span data-translate-key="settings_achievements_title"></span></h4><div id="achievementsGrid" class="achievements-grid"></div></div>
                <div style="border-top: 1px solid var(--border-color); padding-top: 15px; margin-top: 20px;"><h4><i class="fa-solid fa-database"></i> <span data-translate-key="settings_data"></span></h4><div class="modal-data-actions"><button id="exportBtn" class="modal-btn"><i class="fa-solid fa-file-export"></i> <span data-translate-key="btn_export"></span></button><label for="importFile" class="modal-btn import-label"><i class="fa-solid fa-file-import"></i> <span data-translate-key="btn_import"></span></label><input type="file" id="importFile" accept=".json" style="display: none;"></div></div>
            </div>
            <div class="modal-actions"><button id="closeSettings" class="modal-btn btn-primary" data-translate-key="btn_close"></button></div></div>
    </div>
    <div class="modal-overlay" id="dashboardModal"><div class="modal"><div class="modal-header dashboard"><h3 data-translate-key="dashboard_title"></h3></div><div class="modal-body"><div class="chart-container"><h4 data-translate-key="dashboard_weekly_title"></h4><canvas id="completedTasksChart"></canvas></div><div class="chart-container"><h4 data-translate-key="dashboard_category_title"></h4><canvas id="categoryDistributionChart"></canvas></div><div class="chart-container"><h4 data-translate-key="dashboard_pomodoro_title"></h4><canvas id="pomodoroPerformanceChart"></canvas></div><div class="chart-container"><h4 data-translate-key="dashboard_monthly_title"></h4><canvas id="monthlyTasksChart"></canvas></div></div><div class="modal-actions"><button id="closeDashboard" class="modal-btn btn-primary" data-translate-key="btn_close"></button></div></div></div>
    <div class="modal-overlay" id="statsModal"><div class="modal"><div class="modal-header stats"><h3 data-translate-key="stats_title"></h3></div><div class="modal-body"><div class="goals-section"><h4><i class="fa-solid fa-bullseye"></i> <span data-translate-key="stats_goals_title"></span></h4><div class="form-row"><div class="form-group"><label for="dailyTasksGoal" data-translate-key="stats_daily_task_goal"></label><input type="number" id="dailyTasksGoal" min="1"></div><div class="form-group"><label for="dailyPomosGoal" data-translate-key="stats_daily_pomo_goal"></label><input type="number" id="dailyPomosGoal" min="1"></div></div><div id="goalsProgress"></div></div><div style="border-top: 1px solid var(--border-color); padding-top: 15px; margin-top: 20px;"><h4><i class="fa-solid fa-magnifying-glass-chart"></i> <span data-translate-key="stats_details_title"></span></h4><div id="detailedStats" class="detailed-stats-grid"></div></div></div><div class="modal-actions"><button id="closeStats" class="modal-btn btn-primary" data-translate-key="btn_close"></button></div></div></div>

    <div id="toast" class="toast"></div>
    <audio id="notificationSound-classic" src="https://assets.mixkit.co/sfx/preview/mixkit-positive-notification-951.mp3" preload="auto"></audio>
    <audio id="achievementSound-classic" src="https://assets.mixkit.co/sfx/preview/mixkit-video-game-win-2016.mp3" preload="auto"></audio>
    <audio id="notificationSound-digital" src="https://cdn.freesound.org/previews/391/391659_5121236-lq.mp3" preload="auto"></audio>
    <audio id="achievementSound-digital" src="https://cdn.freesound.org/previews/387/387212_5121236-lq.mp3" preload="auto"></audio>
    <audio id="notificationSound-relaxing" src="https://cdn.freesound.org/previews/423/423429_5121236-lq.mp3" preload="auto"></audio>
    <audio id="achievementSound-relaxing" src="https://cdn.freesound.org/previews/258/258020_4432924-lq.mp3" preload="auto"></audio>
    
    <script>
        const translations = {
            es: { title: "üéØ TaskMaster Pro", subtitle: "Organiza tu d√≠a con inteligencia", stat_total: "Total", stat_completed: "Completadas", stat_pending: "Pendientes", stat_overdue: "Vencidas", form_title: "¬øQu√© necesitas hacer hoy?", label_task: "Tarea", placeholder_task: "Ej: Dise√±ar el nuevo logo (Atajo: N)", label_category: "Categor√≠a", cat_work: "üíº Trabajo", cat_personal: "üë§ Personal", cat_health: "üèÉ Salud", cat_study: "üìö Estudio", cat_other: "üìã Otros", label_priority: "Prioridad", prio_low: "üü¢ Baja", prio_medium: "üü° Media", prio_high: "üî¥ Alta", label_date: "Fecha L√≠mite", label_time: "Hora", btn_add_task: "‚ûï Agregar Tarea", placeholder_search: "Buscar tareas...", filter_all: "Todas las categor√≠as", empty_state_title: "¬°Todo despejado!", empty_state_text: "A√±ade una nueva tarea para empezar.", empty_search_title: "Sin resultados", empty_search_text: "No se encontraron tareas con ese filtro.", title_notifications: "üîî Notificaciones", welcome_notification: "¬°Bienvenido! Define tu primera tarea.", title_pomodoro: "üçÖ Pomodoro", delete_modal_title: "‚ö†Ô∏è Confirmar eliminaci√≥n", delete_modal_text: "¬øEst√°s seguro de que quieres eliminar esta tarea?", btn_delete: "Eliminar", btn_cancel: "Cancelar", btn_reset: "Restaurar", edit_modal_title: "‚úèÔ∏è Editar Tarea", label_subtasks: "Sub-tareas", placeholder_subtask: "A√±adir sub-tarea y presionar Enter", settings_title: "‚öôÔ∏è Configuraci√≥n", settings_theme: "Tema", theme_light: "Claro", theme_dark: "Oscuro", theme_ocean: "Oc√©ano", theme_forest: "Bosque", settings_language: "Idioma", settings_data: "Datos de la Aplicaci√≥n", btn_export: "Exportar", btn_import: "Importar", btn_save_changes: "Guardar", btn_close: "Cerrar", feedback_imported: "¬°Datos importados con √©xito!", feedback_error_import: "Error al importar el archivo.", toast_task_added: "Tarea agregada con √©xito", toast_task_deleted: "Tarea eliminada", toast_task_updated: "Tarea actualizada", toast_task_rescheduled: "Tarea reprogramada", toast_achievement_unlocked: "üèÜ ¬°Logro Desbloqueado!", settings_pomodoro: "Personalizaci√≥n de Pomodoro", pomo_work_duration: "Trabajo (min)", pomo_short_break_duration: "Descanso Corto (min)", pomo_long_break_duration: "Descanso Largo (min)", pomo_cycle_work: "¬°A trabajar!", pomo_cycle_short: "Descanso corto", pomo_cycle_long: "Descanso largo", notification_title: "¬°Tiempo!", notification_work_end: "¬°Buen trabajo! Es hora de un descanso.", notification_break_end: "El descanso termin√≥. ¬°De vuelta al trabajo!", label_recurrence: "Recurrencia", recur_none: "Ninguna", recur_daily: "Diaria", recur_weekly: "Semanal", recur_fortnightly: "Quincenal", recur_monthly: "Mensual", recur_business_days: "D√≠as H√°biles (L-V)", pomo_task_title_prefix: "Enfocado en: ", label_notes: "Notas Adicionales", placeholder_notes: "A√±ade detalles, enlaces, etc.", dashboard_title: "üìä Dashboard de Productividad", dashboard_weekly_title: "Tareas Completadas (√öltimos 7 D√≠as)", dashboard_category_title: "Distribuci√≥n por Categor√≠a", dashboard_pomodoro_title: "Rendimiento de Pomodoros", dashboard_monthly_title: "Tareas Completadas (√öltimos 30 D√≠as)", day_sun: "Dom", day_mon: "Lun", day_tue: "Mar", day_wed: "Mi√©", day_thu: "Jue", day_fri: "Vie", day_sat: "S√°b", settings_achievements_title: "Logros", streak_days: "D√≠as", settings_sound_theme: "Tema de Sonido", sound_classic: "Cl√°sico", sound_digital: "Digital", sound_relaxing: "Relajante",
                settings_ui_customization: "Personalizaci√≥n de Interfaz", settings_font: "Fuente", font_sans_serif: "Moderna (Sans-Serif)", font_serif: "Cl√°sica (Serif)", font_mono: "T√©cnica (Monoespaciada)", settings_accent_color: "Color de Acento", settings_general: "Configuraci√≥n General",
                stats_title: "üèÜ Metas y Estad√≠sticas", stats_goals_title: "Metas Diarias", stats_daily_task_goal: "Meta de Tareas", stats_daily_pomo_goal: "Meta de Pomodoros", stats_details_title: "Estad√≠sticas Detalladas", stat_streak: "Racha Actual", stat_today_tasks: "Tareas Hoy", stat_today_pomos: "Pomodoros Hoy", stat_avg_focus: "Foco Promedio", stat_top_category: "Categor√≠a Top",
                ach_first_task_title: "Primer Paso", ach_first_task_desc: "Completa tu primera tarea.",
                ach_ten_tasks_title: " Imparable", ach_ten_tasks_desc: "Completa 10 tareas.",
                ach_first_pomo_title: "Maestro del Foco", ach_first_pomo_desc: "Completa un ciclo Pomodoro.",
                ach_perfectionist_title: "Perfeccionista", ach_perfectionist_desc: "Completa una tarea con sub-tareas.",
                ach_streak_3_title: "En Racha", ach_streak_3_desc: "Mant√©n una racha de 3 d√≠as.",
                ach_night_owl_title: "Ave Nocturna", ach_night_owl_desc: "Completa una tarea de madrugada.",
                calendar_today: "Hoy", calendar_month: "Mes", calendar_week: "Semana", calendar_list: "Lista"
            },
            en: { title: "üéØ TaskMaster Pro", subtitle: "Organize your day with intelligence", stat_total: "Total", stat_completed: "Completed", stat_pending: "Pending", stat_overdue: "Overdue", form_title: "What do you need to do today?", label_task: "Task", placeholder_task: "E.g.: Design the new logo (Shortcut: N)", label_category: "Category", cat_work: "üíº Work", cat_personal: "üë§ Personal", cat_health: "üèÉ Health", cat_study: "üìö Study", cat_other: "üìã Other", label_priority: "Priority", prio_low: "üü¢ Low", prio_medium: "üü° Medium", prio_high: "üî¥ High", label_date: "Due Date", label_time: "Time", btn_add_task: "‚ûï Add Task", placeholder_search: "Search tasks...", filter_all: "All categories", empty_state_title: "All clear!", empty_state_text: "Add a new task to get started.", empty_search_title: "No results", empty_search_text: "No tasks were found with that filter.", title_notifications: "üîî Notifications", welcome_notification: "Welcome! Define your first task.", title_pomodoro: "üçÖ Pomodoro", delete_modal_title: "‚ö†Ô∏è Confirm Deletion", delete_modal_text: "Are you sure you want to delete this task?", btn_delete: "Delete", btn_cancel: "Cancel", btn_reset: "Reset", edit_modal_title: "‚úèÔ∏è Edit Task", label_subtasks: "Sub-tasks", placeholder_subtask: "Add sub-task and press Enter", settings_title: "‚öôÔ∏è Settings", settings_theme: "Theme", theme_light: "Light", theme_dark: "Dark", theme_ocean: "Ocean", theme_forest: "Forest", settings_language: "Language", settings_data: "Application Data", btn_export: "Export", btn_import: "Import", btn_save_changes: "Save", btn_close: "Close", feedback_imported: "Data imported successfully!", feedback_error_import: "Error importing file.", toast_task_added: "Task added successfully", toast_task_deleted: "Task deleted", toast_task_updated: "Task updated", toast_task_rescheduled: "Task rescheduled", toast_achievement_unlocked: "üèÜ Achievement Unlocked!", settings_pomodoro: "Pomodoro Customization", pomo_work_duration: "Work (min)", pomo_short_break_duration: "Short Break (min)", pomo_long_break_duration: "Long Break (min)", pomo_cycle_work: "Time to work!", pomo_cycle_short: "Short break", pomo_cycle_long: "Long break", notification_title: "Time's Up!", notification_work_end: "Good job! Time for a break.", notification_break_end: "Break's over. Back to work!", label_recurrence: "Recurrence", recur_none: "None", recur_daily: "Daily", recur_weekly: "Weekly", recur_fortnightly: "Fortnightly", recur_monthly: "Monthly", recur_business_days: "Business Days (M-F)", pomo_task_title_prefix: "Focused on: ", label_notes: "Additional Notes", placeholder_notes: "Add details, links, etc.", dashboard_title: "üìä Productivity Dashboard", dashboard_weekly_title: "Tasks Completed (Last 7 Days)", dashboard_category_title: "Distribution by Category", dashboard_pomodoro_title: "Pomodoro Performance", dashboard_monthly_title: "Tasks Completed (Last 30 Days)", day_sun: "Sun", day_mon: "Mon", day_tue: "Tue", day_wed: "Wed", day_thu: "Thu", day_fri: "Fri", day_sat: "Sat", settings_achievements_title: "Achievements", streak_days: "Days", settings_sound_theme: "Sound Theme", sound_classic: "Classic", sound_digital: "Digital", sound_relaxing: "Relaxing",
                settings_ui_customization: "Interface Customization", settings_font: "Font", font_sans_serif: "Modern (Sans-Serif)", font_serif: "Classic (Serif)", font_mono: "Technical (Monospace)", settings_accent_color: "Accent Color", settings_general: "General Settings",
                stats_title: "üèÜ Goals & Stats", stats_goals_title: "Daily Goals", stats_daily_task_goal: "Tasks Goal", stats_daily_pomo_goal: "Pomodoros Goal", stats_details_title: "Detailed Stats", stat_streak: "Current Streak", stat_today_tasks: "Tasks Today", stat_today_pomos: "Pomos Today", stat_avg_focus: "Avg. Focus", stat_top_category: "Top Category",
                ach_first_task_title: "First Step", ach_first_task_desc: "Complete your first task.",
                ach_ten_tasks_title: "Unstoppable", ach_ten_tasks_desc: "Complete 10 tasks.",
                ach_first_pomo_title: "Focus Master", ach_first_pomo_desc: "Complete a Pomodoro cycle.",
                ach_perfectionist_title: "Perfectionist", ach_perfectionist_desc: "Complete a task with sub-tasks.",
                ach_streak_3_title: "On a Roll", ach_streak_3_desc: "Keep a 3-day streak.",
                ach_night_owl_title: "Night Owl", ach_night_owl_desc: "Complete a task in the small hours.",
                calendar_today: "Today", calendar_month: "Month", calendar_week: "Week", calendar_list: "List"
            }
        };

        // NUEVO: SVG para estados vac√≠os
        const SVGs = {
            noTasks: `<svg viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg"><path fill="var(--accent-color)" d="M96.4 34.4H75.5V23.3c0-2.3-1.9-4.2-4.2-4.2h-14c-2.3 0-4.2 1.9-4.2 4.2v11.2H31.6c-3.4 0-6.2 2.8-6.2 6.2v67.8c0 3.4 2.8 6.2 6.2 6.2h64.8c3.4 0 6.2-2.8 6.2-6.2V40.6c0-3.4-2.8-6.2-6.2-6.2zM57.1 27.5h13.9v6.9H57.1v-6.9zm41.2 81H31.6c-1 0-1.9-.8-1.9-1.9V40.6c0-1 .8-1.9 1.9-1.9h20v6.9c0 2.3 1.9 4.2 4.2 4.2h14c2.3 0 4.2-1.9 4.2-4.2v-6.9h20.5c1 0 1.9.8 1.9 1.9v67.8c-.1 1.1-.9 1.9-2 1.9z"/><path fill="var(--accent-color)" d="M72.2 69.3h-17c-1.1 0-2-.9-2-2s.9-2 2-2h17c1.1 0 2 .9 2 2s-.9 2-2 2zM85.4 86.8H42.6c-1.1 0-2-.9-2-2s.9-2 2-2h42.8c1.1 0 2 .9 2 2s-.9 2-2 2z"/></svg>`,
            noSearchResults: `<svg viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg"><path fill="var(--accent-color)" d="M115.8 111.9L92.2 88.3c5.8-7.7 9.1-17.1 9.1-27.4C101.3 35.8 83.5 18 58.4 18S15.5 35.8 15.5 60.9s17.8 42.9 42.9 42.9c10.3 0 19.7-3.3 27.4-9.1l23.6 23.6c1.6 1.6 4.2 1.6 5.8 0l.6-.6c1.5-1.6 1.5-4.2-.1-5.8zm-57.4-19c-18.2 0-32.9-14.8-32.9-32.9S40.2 28 58.4 28s32.9 14.8 32.9 32.9-14.7 32-32.9 32z"/></svg>`,
            welcome: `<svg viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg"><path fill="var(--accent-color)" d="M109.9 66.2c-2.3-1.1-5-1.1-7.2.1-5.6 2.8-13.6 4.4-22.3 4.4-12.8 0-22.3-2.6-22.3-2.6-8.7 0-17.8-1.6-22.3-4.4-2.2-1.1-4.9-1.2-7.2-.1-2.3 1.1-3.7 3.4-3.7 5.9v23.2c0 2.5 1.4 4.8 3.7 5.9 2.3 1.1 5 .9 7.2-.1 5.6-2.8 13.6-4.4 22.3-4.4 12.8 0 22.3 2.6 22.3 2.6 8.7 0 17.8 1.6 22.3 4.4 2.2 1.1 4.9 1.2 7.2.1 2.3-1.1 3.7-3.4 3.7-5.9V72.1c.1-2.5-1.3-4.8-3.6-5.9zM103.1 88.5c-6.8-2.6-15.6-4-24.8-4-12.4 0-21.4 2.6-21.4 2.6-9.2 0-18.1 1.4-24.8 4V73c6.8 2.6 15.6 4 24.8 4 12.4 0 21.4-2.6 21.4-2.6 9.2 0 18.1-1.4 24.8-4v15.5z"/><path fill="var(--accent-color)" d="M96.7 45.3c-.6-3.8-3.8-6.6-7.6-6.6-4.2 0-7.6 3.4-7.6 7.6 0 .5.1 1 .2 1.5l-12.2 7c-.5-.1-1-.2-1.5-.2s-1 .1-1.5.2L54.4 48c.1-.5.2-1 .2-1.5 0-4.2-3.4-7.6-7.6-7.6s-7.6 3.4-7.6 7.6c0 .5.1 1 .2 1.5L27.4 54c-2.8-.5-5.4 1.5-5.9 4.3-.5 2.8 1.5 5.4 4.3 5.9l.6.1c.2 0 .5 0 .7 0l12.2-7.1c.5.1 1 .2 1.5.2s1-.1 1.5-.2l12.1 6.9c-.1.5-.2 1-.2 1.5 0 4.2 3.4 7.6 7.6 7.6s7.6-3.4 7.6-7.6c0-.5-.1-1-.2-1.5l12.2-7c.5.1 1 .2 1.5.2s1-.1 1.5-.2l12.1 7.1c2.8.5 5.4-1.5 5.9-4.3.5-2.8-1.5-5.4-4.3-5.9l-.6-.1c-.2 0-.5 0-.7 0l-12.2 7.1c-.5-.1-1-.2-1.5-.2s-1 .1-1.5.2l-12.1-6.9c.1-.5.2-1 .2-1.5 0-.4 0-.8-.1-1.2l12.1-7z"/></svg>`,
        };

        const ACHIEVEMENT_DEFINITIONS = {
            FIRST_TASK: { id: 'ach_first_task', icon: 'fa-shoe-prints', check: (app) => app.tasks.filter(t => t.completed).length >= 1 },
            TEN_TASKS: { id: 'ach_ten_tasks', icon: 'fa-rocket', check: (app) => app.tasks.filter(t => t.completed).length >= 10 },
            FIRST_POMO: { id: 'ach_first_pomo', icon: 'fa-brain', check: (app) => app.tasks.some(t => (t.pomodorosCompleted || 0) > 0) },
            PERFECTIONIST: { id: 'ach_perfectionist', icon: 'fa-check-double', check: (app) => app.tasks.some(t => t.completed && t.subtasks.length > 0 && t.subtasks.every(st => st.completed)) },
            STREAK_3: { id: 'ach_streak_3', icon: 'fa-fire', check: (app) => app.gamificationData.streak.current >= 3 },
            NIGHT_OWL: { id: 'ach_night_owl', icon: 'fa-moon', check: (app, task) => { const hour = new Date(task.completedAt).getHours(); return hour >= 0 && hour < 4; } }
        };

        class TaskMaster {
            constructor() {
                const defaultSettings = { 
                    theme: 'light', 
                    language: 'es', 
                    soundTheme: 'classic', 
                    pomodoro: { work: 25, short: 5, long: 15, cycles: 0 }, 
                    notificationPermission: 'default',
                    goals: { dailyTasks: 5, dailyPomos: 4 },
                    customization: { fontFamily: 'sans-serif', accentColor: '#4facfe' }
                };
                this.tasks = this.loadData('tasks', []);
                this.settings = { ...defaultSettings, customization: {...defaultSettings.customization}, goals: {...defaultSettings.goals}, ...this.loadData('settings', {}) };
                this.gamificationData = { ...{ streak: { current: 0, lastCompletedDate: null }, unlockedAchievements: [] }, ...this.loadData('gamification', {}) };
                
                this.currentPomodoroTask = null; this.pomodoroInterval = null; this.isPomodoroRunning = false;
                this.pomodoroState = { type: 'work', time: this.settings.pomodoro.work * 60 };
                this.currentEditingTask = null; this.draggedTaskElement = null;
                this.charts = {}; this.calendar = null; this.currentView = 'list';

                this.applySettings();
                this.initializeEventListeners();
            }

            loadData(key, defaultValue) { try { const data = localStorage.getItem(`taskmaster-${key}`); return data ? JSON.parse(data) : defaultValue; } catch (e) { console.error(`Error loading data for key: ${key}`, e); return defaultValue; } }
            saveData(key, data) { localStorage.setItem(`taskmaster-${key}`, JSON.stringify(data)); }
            
            applySettings() {
                document.documentElement.setAttribute('data-theme', this.settings.theme);
                document.documentElement.lang = this.settings.language;

                const accentColor = this.settings.customization.accentColor || this.getDefaultAccentColor();
                document.documentElement.style.setProperty('--accent-color', accentColor);
                document.body.style.fontFamily = `var(--font-family-${this.settings.customization.fontFamily})`;
                
                document.getElementById('themeSelector').value = this.settings.theme;
                document.getElementById('languageSelector').value = this.settings.language;
                document.getElementById('soundThemeSelector').value = this.settings.soundTheme;
                document.getElementById('fontSelector').value = this.settings.customization.fontFamily;
                document.getElementById('accentColorPicker').value = accentColor;
                document.getElementById('accentColorValue').textContent = accentColor.toUpperCase();
                document.getElementById('pomodoroWork').value = this.settings.pomodoro.work;
                document.getElementById('pomodoroShortBreak').value = this.settings.pomodoro.short;
                document.getElementById('pomodoroLongBreak').value = this.settings.pomodoro.long;
                this.renderAll();
            }

            // NUEVO: Funci√≥n para obtener el color de acento por defecto del tema actual
            getDefaultAccentColor() {
                const theme = this.settings.theme || 'light';
                const style = getComputedStyle(document.documentElement);
                // Usamos un truco: establecemos el tema temporalmente para leer la variable CSS correcta.
                document.documentElement.setAttribute('data-theme', theme);
                const color = style.getPropertyValue(`--accent-color-default`);
                // Lo restauramos por si acaso, aunque applySettings lo volver√° a hacer.
                document.documentElement.setAttribute('data-theme', this.settings.theme);
                return color.trim();
            }

            showToast(messageKey, type = 'success', extra = '') {
                const toast = document.getElementById('toast');
                toast.innerHTML = `${translations[this.settings.language][messageKey] || messageKey} ${extra}`;
                toast.className = `toast ${type} show`;
                if(type === 'achievement') this.playSound('achievement');
                setTimeout(() => { toast.className = 'toast'; }, 4000);
            }
            playSound(type) {
                const soundId = `${type}Sound-${this.settings.soundTheme}`;
                const sound = document.getElementById(soundId);
                if (sound) sound.play().catch(e => console.error("Error playing sound:", e));
            }
            showModal(id) { document.getElementById(id).style.display = 'block'; }
            hideModal(id) { document.getElementById(id).style.display = 'none'; }
            hideAllModals() { document.querySelectorAll('.modal-overlay').forEach(modal => modal.style.display = 'none'); }

            renderAll() {
                const lang = this.settings.language;
                document.querySelectorAll('[data-translate-key]').forEach(el => {
                    const key = el.getAttribute('data-translate-key'); const translation = translations[lang]?.[key];
                    if (translation) {
                        const container = el.tagName === 'SPAN' || el.parentElement?.tagName === 'LABEL' || el.parentElement?.tagName === 'BUTTON' ? el : el;
                        container.innerHTML = translation;
                    }
                });
                document.querySelectorAll('[data-translate-key-placeholder]').forEach(el => {
                    const key = el.getAttribute('data-translate-key-placeholder');
                    if (translations[lang]?.[key]) el.placeholder = translations[lang][key];
                });
                this.renderStreakCounter(); this.renderStats(); this.renderTaskForm(); this.renderFilterOptions(); this.renderTasks(); this.checkWelcomeNotification(); this.updatePomodoroDisplay();
            }

            renderStreakCounter() {
                const streakCounterEl = document.getElementById('streakCounter');
                if (this.gamificationData.streak.current > 0) {
                    streakCounterEl.innerHTML = `üî• ${this.gamificationData.streak.current} <span data-translate-key="streak_days">${translations[this.settings.language].streak_days}</span>`;
                    streakCounterEl.style.display = 'flex';
                } else {
                    streakCounterEl.style.display = 'none';
                }
            }

            renderStats() {
                const statsContainer = document.getElementById('statsContainer');
                const lang = this.settings.language;
                const total = this.tasks.length;
                const completed = this.tasks.filter(t => t.completed).length;
                const pending = total - completed;
                const overdue = this.tasks.filter(t => !t.completed && t.date && new Date(t.date + 'T00:00:00') < new Date().setHours(0,0,0,0)).length;

                statsContainer.innerHTML = `<div class="stat-card"><div class="stat-number">${total}</div><div class="stat-label" data-translate-key="stat_total">${translations[lang].stat_total}</div></div><div class="stat-card"><div class="stat-number">${completed}</div><div class="stat-label" data-translate-key="stat_completed">${translations[lang].stat_completed}</div></div><div class="stat-card"><div class="stat-number">${pending}</div><div class="stat-label" data-translate-key="stat_pending">${translations[lang].stat_pending}</div></div><div class="stat-card"><div class="stat-number">${overdue}</div><div class="stat-label" data-translate-key="stat_overdue">${translations[lang].stat_overdue}</div></div>`;
            }

            renderTaskForm() {
                const container = document.getElementById('taskFormContainer');
                const lang = this.settings.language;
                if(container.querySelector('#taskForm')) return;
                const recurrenceOptions = ['none', 'daily', 'weekly', 'fortnightly', 'monthly', 'business_days'];
                container.innerHTML = `<h2 class="section-title" data-translate-key="form_title">${translations[lang].form_title}</h2><form id="taskForm" class="task-form"><div class="form-group full-width"><label data-translate-key="label_task">${translations[lang].label_task}</label><input type="text" name="title" required placeholder="${translations[lang].placeholder_task}"></div><div class="form-row"><div class="form-group"><label data-translate-key="label_category">${translations[lang].label_category}</label><select name="category">${Object.keys(translations.es).filter(k=>k.startsWith('cat_')).map(k=>`<option value="${k.replace('cat_','')}">${translations[lang][k]}</option>`).join('')}</select></div><div class="form-group"><label data-translate-key="label_priority">${translations[lang].label_priority}</label><select name="priority">${Object.keys(translations.es).filter(k=>k.startsWith('prio_')).map(k=>`<option value="${k.replace('prio_','')}">${translations[lang][k]}</option>`).join('')}</select></div></div><div class="form-row"><div class="form-group"><label data-translate-key="label_date">${translations[lang].label_date}</label><input type="date" name="date"></div><div class="form-group"><label data-translate-key="label_recurrence">${translations[lang].label_recurrence}</label><select name="recurrence">${recurrenceOptions.map(r => `<option value="${r}">${translations[lang]['recur_' + r]}</option>`).join('')}</select></div></div><button type="submit" class="btn btn-primary full-width" data-translate-key="btn_add_task">${translations[lang].btn_add_task}</button></form>`;
                document.getElementById('taskForm').addEventListener('submit', this.handleAddTask.bind(this));
            }

            renderFilterOptions() {
                const filter = document.getElementById('filterCategory');
                const lang = this.settings.language;
                const currentFilterValue = filter.value;
                const categories = ['all', ...new Set(this.tasks.map(t => t.category))];
                filter.innerHTML = categories.map(cat => `<option value="${cat}">${translations[lang][cat === 'all' ? 'filter_all' : `cat_${cat}`] || cat}</option>`).join('');
                filter.value = currentFilterValue || 'all';
            }
            
            renderTasks() {
                const list = document.getElementById('tasksList');
                const lang = this.settings.language;
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const filterCat = document.getElementById('filterCategory').value;
                
                const taskSorter = (a, b) => {
                    if (a.completed !== b.completed) return a.completed ? 1 : -1;
                    const dateA = a.date ? new Date(a.date) : 0;
                    const dateB = b.date ? new Date(b.date) : 0;
                    if(dateA && dateB) return dateA - dateB;
                    if(dateA) return -1;
                    if(dateB) return 1;
                    return 0;
                };

                const filteredTasks = this.tasks
                    .filter(task => (task.title.toLowerCase().includes(searchTerm) || (task.notes && task.notes.toLowerCase().includes(searchTerm))) && (filterCat === 'all' || task.category === filterCat))
                    .sort(taskSorter);

                if (this.tasks.length === 0) { list.innerHTML = `<div class="empty-state">${SVGs.noTasks}<h4 data-translate-key="empty_state_title">${translations[lang].empty_state_title}</h4><p data-translate-key="empty_state_text">${translations[lang].empty_state_text}</p></div>`; return; }

                if (filteredTasks.length === 0) {
                     list.innerHTML = `<div class="empty-state">${SVGs.noSearchResults}<h4 data-translate-key="empty_search_title">${translations[lang].empty_search_title}</h4><p data-translate-key="empty_search_text">${translations[lang].empty_search_text}</p></div>`;
                     return;
                }
                
                list.innerHTML = '';
                filteredTasks.forEach(task => list.appendChild(this.createTaskElement(task)));
            }

            createTaskElement(task) {
                const taskEl = document.createElement('div');
                const lang = this.settings.language;
                const today = new Date().setHours(0, 0, 0, 0); const taskDate = task.date ? new Date(task.date+'T00:00:00').getTime() : null; let dateClass = '';
                if (!task.completed && taskDate) { if (taskDate < today) dateClass = 'task-overdue'; else if (taskDate === today) dateClass = 'task-due-today'; }
                taskEl.className = `task-item ${task.completed ? 'completed' : ''} ${this.currentPomodoroTask === task.id ? 'pomodoro-active' : ''} ${dateClass}`;
                taskEl.dataset.id = task.id; taskEl.draggable = true;
                const priorityColors = { low: 'var(--prio-low)', medium: 'var(--prio-medium)', high: 'var(--prio-high)'};
                if (!dateClass) { taskEl.style.borderLeftColor = priorityColors[task.priority] || '#cbd5e0'; }
                const subtasksDone = task.subtasks.filter(st => st.completed).length; const progress = task.subtasks.length > 0 ? (subtasksDone / task.subtasks.length) * 100 : (task.completed ? 100 : 0);
                const recurrenceText = task.recurrence && task.recurrence !== 'none' ? `<span><i class="fa-solid fa-repeat"></i> ${translations[lang]['recur_'+task.recurrence] || ''}</span>` : '';
                const completeBtnClass = task.completed ? 'is-completed' : 'is-pending';
                const subtasksHTML = task.subtasks.length > 0 ? `<div class="task-subtasks">${task.subtasks.map(st => `
                    <div class="task-subtask-item ${st.completed ? 'completed' : ''}" data-subtask-id="${st.id}">
                        <input type="checkbox" id="subtask-${st.id}" data-task-id="${task.id}" ${st.completed ? 'checked' : ''} />
                        <label for="subtask-${st.id}">${st.title}</label>
                    </div>`).join('')}</div>` : '';
                taskEl.innerHTML = `<div class="task-header"><div class="task-info"><h4 class="task-title">${task.title}</h4><div class="task-meta">${task.notes ? '<span><i class="fa-solid fa-note-sticky"></i></span>' : ''}<span><i class="fa-solid fa-tag"></i> ${translations[lang]['cat_'+task.category] || task.category}</span>${task.date ? `<span><i class="fa-solid fa-calendar-days"></i> ${new Date(task.date + 'T00:00:00').toLocaleDateString(lang)}</span>` : ''}${recurrenceText}</div></div><div class="task-actions"><button class="btn-icon pomodoro-start-btn" aria-label="Iniciar Pomodoro para esta tarea" title="Iniciar Pomodoro"><i class="fa-solid fa-clock"></i></button><button class="btn-icon edit-btn" aria-label="Editar tarea" title="Editar"><i class="fa-solid fa-pencil"></i></button><button class="btn-icon delete-btn" aria-label="Eliminar tarea" title="Eliminar"><i class="fa-solid fa-trash-can"></i></button><button class="btn-icon complete-btn ${completeBtnClass}" aria-label="Marcar como completada" title="Completar"><i class="fa-solid fa-circle-check"></i></button></div></div>${subtasksHTML}${(task.subtasks.length > 0 || task.completed) ? `<div class="task-progress"><div class="progress-bar" style="width: ${progress}%"></div></div>` : ''}`;
                return taskEl;
            }

            checkWelcomeNotification() { 
                const welcomeEl = document.getElementById('welcomeNotification');
                if (this.tasks.length > 0) {
                    welcomeEl.style.display = 'none';
                } else {
                    const lang = this.settings.language;
                    welcomeEl.innerHTML = `${SVGs.welcome} <strong>${translations[lang].welcome_notification}</strong>`;
                    welcomeEl.style.display = 'block';
                }
            }
            
            initializeEventListeners() {
                document.addEventListener('keydown', this.handleKeyboardShortcuts.bind(this));
                document.getElementById('searchInput').addEventListener('input', () => this.renderTasks());
                document.getElementById('filterCategory').addEventListener('change', () => this.renderTasks());
                
                document.getElementById('listViewBtn').addEventListener('click', () => this.toggleView('list'));
                document.getElementById('calendarViewBtn').addEventListener('click', () => this.toggleView('calendar'));
                document.getElementById('statsBtn').addEventListener('click', () => this.showStatsDashboard());
                document.getElementById('dashboardBtn').addEventListener('click', () => this.showDashboard());
                document.getElementById('settingsBtn').addEventListener('click', () => { this.requestNotificationPermission(); this.renderAchievements(); this.showModal('settingsModal'); });
                
                document.getElementById('closeDashboard').addEventListener('click', () => this.hideModal('dashboardModal'));
                document.getElementById('closeStats').addEventListener('click', () => this.hideModal('statsModal'));
                document.getElementById('closeSettings').addEventListener('click', () => { this.hideModal('settingsModal'); this.applySettings(); });
                
                document.getElementById('themeSelector').addEventListener('change', (e) => { this.settings.theme = e.target.value; this.saveData('settings', this.settings); this.applySettings(); });
                document.getElementById('languageSelector').addEventListener('change', (e) => { this.settings.language = e.target.value; this.saveData('settings', this.settings); this.applySettings(); if(this.calendar) {this.calendar.setOption('locale', e.target.value); this.calendar.setOption('buttonText', this.getCalendarButtonTranslations());} });
                document.getElementById('soundThemeSelector').addEventListener('change', (e) => { this.settings.soundTheme = e.target.value; this.saveData('settings', this.settings); this.playSound('notification'); });

                document.getElementById('fontSelector').addEventListener('change', (e) => { this.settings.customization.fontFamily = e.target.value; this.saveData('settings', this.settings); this.applySettings(); });
                document.getElementById('accentColorPicker').addEventListener('input', (e) => { this.settings.customization.accentColor = e.target.value; this.saveData('settings', this.settings); this.applySettings(); });
                document.getElementById('resetAccentColor').addEventListener('click', () => { this.settings.customization.accentColor = this.getDefaultAccentColor(); this.saveData('settings', this.settings); this.applySettings(); });
                
                document.getElementById('dailyTasksGoal').addEventListener('change', (e) => { this.settings.goals.dailyTasks = parseInt(e.target.value, 10) || 5; this.saveData('settings', this.settings); this.renderGoalsProgress(); });
                document.getElementById('dailyPomosGoal').addEventListener('change', (e) => { this.settings.goals.dailyPomos = parseInt(e.target.value, 10) || 4; this.saveData('settings', this.settings); this.renderGoalsProgress(); });

                document.getElementById('exportBtn').addEventListener('click', this.exportData.bind(this));
                document.getElementById('importFile').addEventListener('change', this.importData.bind(this));
                
                document.getElementById('playBtn').addEventListener('click', () => this.startPomodoro()); document.getElementById('pauseBtn').addEventListener('click', () => this.pausePomodoro()); document.getElementById('resetBtn').addEventListener('click', () => this.resetPomodoro(true)); document.getElementById('skipBtn').addEventListener('click', () => this.nextPomodoroCycle(true));
                document.getElementById('pomodoroWork').addEventListener('change', (e) => this.updatePomodoroSetting('work', e.target.value)); document.getElementById('pomodoroShortBreak').addEventListener('change', (e) => this.updatePomodoroSetting('short', e.target.value)); document.getElementById('pomodoroLongBreak').addEventListener('change', (e) => this.updatePomodoroSetting('long', e.target.value));
                
                const tasksList = document.getElementById('tasksList');
                tasksList.addEventListener('click', this.handleTaskListClick.bind(this)); tasksList.addEventListener('dragstart', this.handleDragStart.bind(this)); tasksList.addEventListener('dragover', this.handleDragOver.bind(this)); tasksList.addEventListener('drop', this.handleDrop.bind(this));
                
                document.getElementById('cancelDelete').addEventListener('click', () => this.hideModal('deleteModal')); document.getElementById('cancelEdit').addEventListener('click', () => this.hideModal('editTaskModal')); document.getElementById('saveEdit').addEventListener('click', () => this.saveEditedTask());
                document.getElementById('newSubtaskInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') { e.preventDefault(); this.addSubtask(); }});
                document.getElementById('editSubtaskList').addEventListener('click', (e) => { if(e.target.closest('.delete-subtask-btn')) this.deleteSubtask(e.target.closest('.delete-subtask-btn').dataset.subtaskId); });
            }
            
            handleKeyboardShortcuts(e) {
                if (document.querySelector('.modal-overlay[style*="display: block"]') || document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA' || document.activeElement.tagName === 'SELECT') { if (e.key === 'Escape') this.hideAllModals(); return; }
                switch(e.key.toLowerCase()) {
                    case 'n': e.preventDefault(); document.querySelector('#taskFormContainer input[name="title"]').focus(); break;
                    case 'f': e.preventDefault(); document.getElementById('searchInput').focus(); break;
                    case 'd': e.preventDefault(); this.showDashboard(); break;
                    case 'm': e.preventDefault(); this.showStatsDashboard(); break;
                    case 's': e.preventDefault(); this.renderAchievements(); this.showModal('settingsModal'); break;
                    case 'c': e.preventDefault(); this.toggleView('calendar'); break;
                    case 'l': e.preventDefault(); this.toggleView('list'); break;
                    case 'escape': this.hideAllModals(); break;
                }
            }

            handleTaskListClick(e) { 
                const taskEl = e.target.closest('.task-item'); if(!taskEl) return; 
                const taskId = taskEl.dataset.id; 
                if(e.target.closest('.delete-btn')) this.showDeleteModal(taskId); 
                else if(e.target.closest('.complete-btn')) this.toggleTaskCompletion(taskId); 
                else if(e.target.closest('.edit-btn')) this.showEditModal(taskId); 
                else if(e.target.closest('.pomodoro-start-btn')) { if (this.settings.notificationPermission !== 'granted') this.requestNotificationPermission(); this.startPomodoroForTask(taskId); }
                else if(e.target.matches('input[type="checkbox"]')) { const subtaskId = e.target.parentElement.dataset.subtaskId; this.toggleInlineSubtask(taskId, subtaskId); }
            }
            
            handleAddTask(e) {
                e.preventDefault(); const form = e.target; const formData = new FormData(form); const title = formData.get('title').trim(); if (!title) return;
                const newTask = { id: `task-${Date.now()}`, title, category: formData.get('category'), priority: formData.get('priority'), recurrence: formData.get('recurrence'), date: formData.get('date') || null, completed: false, completedAt: null, pomodorosCompleted: 0, subtasks: [], notes: '' };
                this.tasks.unshift(newTask); this.saveData('tasks', this.tasks); document.getElementById('filterCategory').value = 'all'; this.renderAll(); if(this.calendar) this.calendar.refetchEvents(); form.reset(); this.showToast('toast_task_added'); this.checkAchievements();
            }

            getNextBusinessDay(date) {
                const newDate = new Date(date);
                newDate.setDate(newDate.getDate() + 1);
                if (newDate.getDay() === 6) { newDate.setDate(newDate.getDate() + 2); } 
                else if (newDate.getDay() === 0) { newDate.setDate(newDate.getDate() + 1); }
                return newDate;
            }

            toggleTaskCompletion(taskId) {
                const taskEl = document.querySelector(`.task-item[data-id="${taskId}"]`);
                const task = this.tasks.find(t => t.id === taskId); if(!task) return;
                const wasCompleted = task.completed; task.completed = !task.completed; task.completedAt = task.completed ? Date.now() : null;
                if (task.completed && !wasCompleted) { this.updateStreak(); this.checkAchievements(task); }
                if (task.completed && task.recurrence !== 'none' && task.date) { 
                    const newTask = { ...task, id: `task-${Date.now()}`, completed: false, completedAt: null, subtasks: task.subtasks.map(st => ({...st, completed: false})) }; 
                    const newDate = new Date(task.date + 'T00:00:00'); 
                    switch(task.recurrence) {
                        case 'daily': newDate.setDate(newDate.getDate() + 1); break;
                        case 'weekly': newDate.setDate(newDate.getDate() + 7); break;
                        case 'fortnightly': newDate.setDate(newDate.getDate() + 14); break;
                        case 'monthly': newDate.setMonth(newDate.getMonth() + 1); break;
                        case 'business_days': Object.assign(newDate, this.getNextBusinessDay(newDate)); break;
                    }
                    newTask.date = newDate.toISOString().split('T')[0]; 
                    this.tasks.push(newTask); 
                }
                
                if (taskEl) {
                    taskEl.classList.add('slide-out');
                    setTimeout(() => {
                        this.saveData('tasks', this.tasks); this.renderAll(); if(this.calendar) this.calendar.refetchEvents(); this.showToast('toast_task_updated');
                    }, 500);
                } else {
                    this.saveData('tasks', this.tasks); this.renderAll(); if(this.calendar) this.calendar.refetchEvents(); this.showToast('toast_task_updated');
                }
            }
            
            showDeleteModal(taskId) { const lang = this.settings.language; const modal = document.getElementById('deleteModal'); modal.querySelector('h3').textContent = translations[lang].delete_modal_title; modal.querySelector('p').textContent = translations[lang].delete_modal_text; modal.querySelector('#cancelDelete').textContent = translations[lang].btn_cancel; modal.querySelector('#confirmDelete').textContent = translations[lang].btn_delete; this.showModal('deleteModal'); document.getElementById('confirmDelete').onclick = () => { const taskEl = document.querySelector(`.task-item[data-id="${taskId}"]`); if (taskEl) { taskEl.classList.add('slide-out'); } setTimeout(() => { this.tasks = this.tasks.filter(t => t.id !== taskId); if (this.currentPomodoroTask === taskId) this.resetPomodoro(true); this.saveData('tasks', this.tasks); this.renderAll(); if(this.calendar) this.calendar.refetchEvents(); this.hideModal('deleteModal'); this.showToast('toast_task_deleted', 'error');}, 500); }; }
            showEditModal(taskId) { this.currentEditingTask = this.tasks.find(t => t.id === taskId); if (!this.currentEditingTask) return; const lang = this.settings.language; const modal = document.getElementById('editTaskModal'); modal.querySelector('h3').textContent = translations[lang].edit_modal_title; modal.querySelector('label[data-translate-key="label_task"]').textContent = translations[lang].label_task; modal.querySelector('label[data-translate-key="label_notes"]').textContent = translations[lang].label_notes; modal.querySelector('label[data-translate-key="label_subtasks"]').textContent = translations[lang].label_subtasks; modal.querySelector('#newSubtaskInput').placeholder = translations[lang].placeholder_subtask; modal.querySelector('#editTaskNotes').placeholder = translations[lang].placeholder_notes; modal.querySelector('#cancelEdit').textContent = translations[lang].btn_cancel; modal.querySelector('#saveEdit').textContent = translations[lang].btn_save_changes; document.getElementById('editTaskTitle').value = this.currentEditingTask.title; document.getElementById('editTaskNotes').value = this.currentEditingTask.notes || ''; this.renderSubtasks(); this.showModal('editTaskModal'); }
            saveEditedTask() { if (!this.currentEditingTask) return; this.currentEditingTask.title = document.getElementById('editTaskTitle').value.trim(); this.currentEditingTask.notes = document.getElementById('editTaskNotes').value.trim(); this.saveData('tasks', this.tasks); this.hideModal('editTaskModal'); this.renderAll(); if(this.calendar) this.calendar.refetchEvents(); this.showToast('toast_task_updated'); this.currentEditingTask = null; }
            renderSubtasks() { const list = document.getElementById('editSubtaskList'); list.innerHTML = this.currentEditingTask.subtasks.map(subtask => `<div class="subtask-item" data-subtask-id="${subtask.id}"><label class="${subtask.completed ? 'completed' : ''}"><input type="checkbox" ${subtask.completed ? 'checked' : ''} onchange="app.toggleSubtask('${subtask.id}')"><span>${subtask.title}</span></label><button class="btn-icon delete-subtask-btn" data-subtask-id="${subtask.id}"><i class="fa-solid fa-times"></i></button></div>`).join(''); }
            addSubtask() { const input = document.getElementById('newSubtaskInput'); const title = input.value.trim(); if (title && this.currentEditingTask) { this.currentEditingTask.subtasks.push({ id: `sub-${Date.now()}`, title, completed: false }); input.value = ''; this.renderSubtasks(); } }
            toggleSubtask(subtaskId) { const subtask = this.currentEditingTask.subtasks.find(st => st.id === subtaskId); if (subtask) subtask.completed = !subtask.completed; this.renderSubtasks(); }
            deleteSubtask(subtaskId) { this.currentEditingTask.subtasks = this.currentEditingTask.subtasks.filter(st => st.id !== subtaskId); this.renderSubtasks(); }
            toggleInlineSubtask(taskId, subtaskId) { const task = this.tasks.find(t => t.id === taskId); const subtask = task.subtasks.find(st => st.id === subtaskId); if (subtask) { subtask.completed = !subtask.completed; this.saveData('tasks', this.tasks); this.renderAll(); this.checkAchievements(); } }
            
            handleDragStart(e) { if(e.target.classList.contains('task-item')) { this.draggedTaskElement = e.target; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', e.target.dataset.id); setTimeout(() => { e.target.classList.add('dragging'); }, 0); } }
            handleDragOver(e) { e.preventDefault(); }
            handleDrop(e) { e.preventDefault(); const draggedId = e.dataTransfer.getData('text/plain'); if (!draggedId || !this.draggedTaskElement) return; const dropTarget = e.target.closest('.task-item'); this.draggedTaskElement.classList.remove('dragging'); if (dropTarget && dropTarget.dataset.id !== draggedId) { const draggedIndex = this.tasks.findIndex(t => t.id === draggedId); const targetIndex = this.tasks.findIndex(t => t.id === dropTarget.dataset.id); const [draggedItem] = this.tasks.splice(draggedIndex, 1); this.tasks.splice(targetIndex, 0, draggedItem); this.saveData('tasks', this.tasks); this.renderTasks(); } }

            updateStreak() { const today = new Date().toISOString().split('T')[0]; const lastDate = this.gamificationData.streak.lastCompletedDate; if (today === lastDate) return; const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1); const yesterdayStr = yesterday.toISOString().split('T')[0]; if (lastDate === yesterdayStr) { this.gamificationData.streak.current++; } else { this.gamificationData.streak.current = 1; } this.gamificationData.streak.lastCompletedDate = today; this.saveData('gamification', this.gamificationData); }
            checkAchievements(task = null) { const lang = this.settings.language; for (const key in ACHIEVEMENT_DEFINITIONS) { const ach = ACHIEVEMENT_DEFINITIONS[key]; if (!this.gamificationData.unlockedAchievements.includes(ach.id) && ach.check(this, task)) { this.gamificationData.unlockedAchievements.push(ach.id); this.saveData('gamification', this.gamificationData); this.showToast('toast_achievement_unlocked', 'achievement', translations[lang][`${ach.id}_title`]); } } }
            renderAchievements() { const grid = document.getElementById('achievementsGrid'); const lang = this.settings.language; grid.innerHTML = Object.values(ACHIEVEMENT_DEFINITIONS).map(ach => { const unlocked = this.gamificationData.unlockedAchievements.includes(ach.id); return `<div class="achievement-item ${unlocked ? 'unlocked' : ''}" title="${translations[lang][`${ach.id}_desc`]}"><i class="fa-solid ${ach.icon} achievement-icon"></i><span class="ach-title">${translations[lang][`${ach.id}_title`]}</span></div>`; }).join(''); }
            
            finishPomodoroCycle() {
                this.playSound('notification');
                const timerEl = document.getElementById('pomodoroTimer'); timerEl.classList.add('finished');
                if(this.pomodoroState.type === 'work' && this.currentPomodoroTask) { const task = this.tasks.find(t => t.id === this.currentPomodoroTask); if(task) { task.pomodorosCompleted = (task.pomodorosCompleted || 0) + 1; this.saveData('tasks', this.tasks); this.checkAchievements(); } }
                const lang = this.settings.language; this.showPushNotification(translations[lang].notification_title, this.pomodoroState.type === 'work' ? translations[lang].notification_work_end : translations[lang].notification_break_end);
                setTimeout(() => { timerEl.classList.remove('finished'); this.nextPomodoroCycle(false); }, 3000);
            }
            updatePomodoroSetting(key, value) { this.settings.pomodoro[key] = parseInt(value, 10); this.saveData('settings', this.settings); if(!this.isPomodoroRunning) this.resetPomodoro(false); this.showToast('toast_task_updated'); }
            startPomodoroForTask(taskId) { this.currentPomodoroTask = taskId; this.resetPomodoro(false); this.startPomodoro(); this.renderTasks(); }
            startPomodoro() { if (this.isPomodoroRunning) return; this.isPomodoroRunning = true; document.body.classList.add('focus-mode'); this.pomodoroInterval = setInterval(() => { this.pomodoroState.time--; this.updatePomodoroDisplay(); if (this.pomodoroState.time < 0) this.finishPomodoroCycle(); }, 1000); }
            pausePomodoro() { clearInterval(this.pomodoroInterval); this.isPomodoroRunning = false; document.body.classList.remove('focus-mode'); }
            resetPomodoro(fullReset) { this.pausePomodoro(); if (fullReset) { this.settings.pomodoro.cycles = 0; this.currentPomodoroTask = null; } this.pomodoroState = { type: 'work', time: this.settings.pomodoro.work * 60 }; this.updatePomodoroDisplay(); if (fullReset) this.renderTasks(); }
            nextPomodoroCycle(isSkip) { this.pausePomodoro(); if (this.pomodoroState.type === 'work') { this.settings.pomodoro.cycles++; this.pomodoroState = { type: (this.settings.pomodoro.cycles % 4 === 0 ? 'long' : 'short'), time: this.settings.pomodoro[(this.settings.pomodoro.cycles % 4 === 0 ? 'long' : 'short')] * 60 }; } else { this.pomodoroState = { type: 'work', time: this.settings.pomodoro.work * 60 }; } this.saveData('settings', this.settings); this.updatePomodoroDisplay(); if (!isSkip) this.startPomodoro(); }
            updatePomodoroDisplay() { const { time, type } = this.pomodoroState; document.getElementById('pomodoroTimer').textContent = `${Math.floor(time / 60).toString().padStart(2, '0')}:${(time % 60).toString().padStart(2, '0')}`; const lang = this.settings.language; document.getElementById('pomodoroCycleTitle').textContent = translations[lang][`pomo_cycle_${type === 'short' ? 'short' : type === 'long' ? 'long' : 'work'}`]; const taskTitleEl = document.getElementById('pomodoroTaskTitle'); if(this.currentPomodoroTask){ const task = this.tasks.find(t => t.id === this.currentPomodoroTask); taskTitleEl.textContent = task ? `${translations[lang].pomo_task_title_prefix}${task.title}` : ''; } else { taskTitleEl.textContent = ''; } }
            
            toggleView(view) {
                if (this.currentView === view) return; this.currentView = view;
                const listView = document.getElementById('list-view-section'); const calendarView = document.getElementById('calendar-view-section'); const listBtn = document.getElementById('listViewBtn'); const calendarBtn = document.getElementById('calendarViewBtn');
                if (view === 'calendar') { listView.classList.add('view-hidden'); calendarView.classList.remove('view-hidden'); listBtn.classList.remove('active'); calendarBtn.classList.add('active'); this.initializeCalendar(); } 
                else { listView.classList.remove('view-hidden'); calendarView.classList.add('view-hidden'); listBtn.classList.add('active'); calendarBtn.classList.remove('active'); }
            }

            getCalendarButtonTranslations() {
                const lang = this.settings.language;
                return { today: translations[lang].calendar_today, month: translations[lang].calendar_month, week: translations[lang].calendar_week, list: translations[lang].calendar_list };
            }

            initializeCalendar() {
                if (this.calendar) { this.calendar.refetchEvents(); return; }
                const calendarEl = document.getElementById('calendar');
                const priorityColors = { low: 'var(--prio-low)', medium: 'var(--prio-medium)', high: 'var(--prio-high)'};
                
                this.calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth', locale: this.settings.language, buttonText: this.getCalendarButtonTranslations(),
                    headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' },
                    events: (fetchInfo, successCallback, failureCallback) => {
                        const events = this.tasks
                            .filter(t => t.date && !t.completed)
                            .map(t => ({ 
                                id: t.id, 
                                title: t.title, 
                                start: t.date, 
                                color: priorityColors[t.priority] || 'var(--accent-color)', 
                                allDay: true 
                            }));
                        successCallback(events);
                    },
                    editable: true,
                    eventDrop: (info) => {
                        const taskId = info.event.id;
                        const newDate = info.event.start.toISOString().split('T')[0];
                        const task = this.tasks.find(t => t.id === taskId);
                        if (task) {
                            task.date = newDate;
                            this.saveData('tasks', this.tasks);
                            this.renderTasks();
                            this.showToast('toast_task_rescheduled');
                        }
                    }
                });
                this.calendar.render();
            }

            showDashboard() { this.showModal('dashboardModal'); setTimeout(() => { this.renderWeeklyChart(); this.renderCategoryChart(); this.renderPomodoroChart(); this.renderMonthlyChart(); }, 100); }
            renderChart(canvasId, type, data, options = {}) { if (this.charts[canvasId]) { this.charts[canvasId].destroy(); } const ctx = document.getElementById(canvasId); if (!ctx) return; this.charts[canvasId] = new Chart(ctx.getContext('2d'), { type, data, options }); }
            renderWeeklyChart() { const lang = this.settings.language; const labels = []; const data = [0, 0, 0, 0, 0, 0, 0]; const dayKeys = ['day_sun', 'day_mon', 'day_tue', 'day_wed', 'day_thu', 'day_fri', 'day_sat']; for (let i = 6; i >= 0; i--) { const date = new Date(); date.setDate(date.getDate() - i); labels.push(translations[lang][dayKeys[date.getDay()]]); } const sevenDaysAgo = new Date(); sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7); this.tasks.filter(t => t.completed && t.completedAt && new Date(t.completedAt) > sevenDaysAgo).forEach(task => { const completedDate = new Date(task.completedAt); const diffDays = Math.floor((new Date().setHours(0,0,0,0) - completedDate.setHours(0,0,0,0)) / (1000 * 60 * 60 * 24)); if(diffDays >= 0 && diffDays < 7) { data[6 - diffDays]++; } }); this.renderChart('completedTasksChart', 'bar', { labels, datasets: [{ label: translations[lang].stat_completed, data, backgroundColor: 'rgba(79, 172, 254, 0.5)', borderColor: 'rgba(79, 172, 254, 1)', borderWidth: 1 }] }, { responsive: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1, color: getComputedStyle(document.body).getPropertyValue('--text-muted') } }, x: { ticks: { color: getComputedStyle(document.body).getPropertyValue('--text-muted') } } }, plugins: { legend: { labels: { color: getComputedStyle(document.body).getPropertyValue('--text-muted') } } } }); }
            renderCategoryChart() { const lang = this.settings.language; const categoryCounts = this.tasks.reduce((acc, task) => { acc[task.category] = (acc[task.category] || 0) + 1; return acc; }, {}); const labels = Object.keys(categoryCounts).map(cat => translations[lang]['cat_' + cat] || cat); const data = Object.values(categoryCounts); this.renderChart('categoryDistributionChart', 'doughnut', { labels, datasets: [{ data, backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'], }] }, { responsive: true, plugins: { legend: { position: 'top', labels: { color: getComputedStyle(document.body).getPropertyValue('--text-muted') } } } }); }
            renderPomodoroChart() { const lang = this.settings.language; const pomodoroTasks = this.tasks.filter(t => (t.pomodorosCompleted || 0) > 0).sort((a,b) => b.pomodorosCompleted - a.pomodorosCompleted).slice(0, 7); const labels = pomodoroTasks.map(t => t.title.length > 25 ? t.title.substring(0, 22) + '...' : t.title); const data = pomodoroTasks.map(t => t.pomodorosCompleted); this.renderChart('pomodoroPerformanceChart', 'bar', { labels, datasets: [{ label: 'Pomodoros', data, backgroundColor: 'rgba(255, 159, 64, 0.5)', borderColor: 'rgba(255, 159, 64, 1)', borderWidth: 1 }] }, { responsive: true, indexAxis: 'y', scales: { y: { ticks: { color: getComputedStyle(document.body).getPropertyValue('--text-muted') } }, x: { ticks: { stepSize: 1, color: getComputedStyle(document.body).getPropertyValue('--text-muted') } } }, plugins: { legend: { labels: { color: getComputedStyle(document.body).getPropertyValue('--text-muted') } } } }); }
            renderMonthlyChart() { const lang = this.settings.language; const labels = []; const data = Array(30).fill(0); const thirtyDaysAgo = new Date(); thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30); for (let i = 29; i >= 0; i--) { const date = new Date(); date.setDate(date.getDate() - i); labels.push(date.toLocaleDateString(lang, { month: 'short', day: 'numeric' })); } this.tasks.filter(t => t.completed && t.completedAt && new Date(t.completedAt) > thirtyDaysAgo).forEach(task => { const completedDate = new Date(task.completedAt); const diffDays = Math.floor((new Date().setHours(0,0,0,0) - completedDate.setHours(0,0,0,0)) / (1000 * 60 * 60 * 24)); if(diffDays >= 0 && diffDays < 30) { data[29 - diffDays]++; } }); this.renderChart('monthlyTasksChart', 'line', { labels, datasets: [{ label: translations[lang].stat_completed, data, backgroundColor: 'rgba(75, 192, 192, 0.2)', borderColor: 'rgba(75, 192, 192, 1)', borderWidth: 2, tension: 0.3 }] }, { responsive: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1, color: getComputedStyle(document.body).getPropertyValue('--text-muted') } }, x: { ticks: { color: getComputedStyle(document.body).getPropertyValue('--text-muted') } } }, plugins: { legend: { display: false } } }); }
            
            showStatsDashboard() {
                document.getElementById('dailyTasksGoal').value = this.settings.goals.dailyTasks;
                document.getElementById('dailyPomosGoal').value = this.settings.goals.dailyPomos;
                this.renderGoalsProgress();
                this.renderDetailedStats();
                this.showModal('statsModal');
            }

            renderGoalsProgress() {
                const lang = this.settings.language;
                const today = new Date().toISOString().split('T')[0];
                const tasksToday = this.tasks.filter(t => t.completed && new Date(t.completedAt).toISOString().startsWith(today)).length;
                const pomosToday = this.tasks.reduce((acc, task) => {
                    if (task.completed && new Date(task.completedAt).toISOString().startsWith(today)) {
                        return acc + (task.pomodorosCompleted || 0);
                    }
                    return acc;
                }, 0);

                const taskGoal = this.settings.goals.dailyTasks;
                const pomoGoal = this.settings.goals.dailyPomos;
                const taskProgress = Math.min((tasksToday / taskGoal) * 100, 100);
                const pomoProgress = Math.min((pomosToday / pomoGoal) * 100, 100);

                const container = document.getElementById('goalsProgress');
                container.innerHTML = `
                    <div class="goal-progress">
                        <label><span>${translations[lang].stats_daily_task_goal}</span><span>${tasksToday} / ${taskGoal}</span></label>
                        <div class="progress-bar-container"><div class="progress-bar-fill" style="width: ${taskProgress}%">${Math.round(taskProgress)}%</div></div>
                    </div>
                    <div class="goal-progress">
                        <label><span>${translations[lang].stats_daily_pomo_goal}</span><span>${pomosToday} / ${pomoGoal}</span></label>
                        <div class="progress-bar-container"><div class="progress-bar-fill" style="width: ${pomoProgress}%">${Math.round(pomoProgress)}%</div></div>
                    </div>
                `;
            }

            renderDetailedStats() {
                const lang = this.settings.language;
                const container = document.getElementById('detailedStats');
                const today = new Date().toISOString().split('T')[0];

                const tasksTodayCount = this.tasks.filter(t => t.completed && new Date(t.completedAt).toISOString().startsWith(today)).length;
                const pomosTodayCount = this.tasks.reduce((acc, t) => {
                    if (t.completed && new Date(t.completedAt).toISOString().startsWith(today)) {
                        return acc + (t.pomodorosCompleted || 0);
                    } return acc;
                }, 0);
                
                const totalPomos = this.tasks.reduce((acc, task) => acc + (task.pomodorosCompleted || 0), 0);
                const tasksWithPomos = this.tasks.filter(t => (t.pomodorosCompleted || 0) > 0).length;
                const avgFocusTime = tasksWithPomos > 0 ? ((totalPomos * this.settings.pomodoro.work) / tasksWithPomos).toFixed(1) : 0;
                
                const categoryCounts = this.tasks.filter(t => t.completed).reduce((acc, task) => {
                    acc[task.category] = (acc[task.category] || 0) + 1;
                    return acc;
                }, {});
                const topCategory = Object.keys(categoryCounts).sort((a,b) => categoryCounts[b] - categoryCounts[a])[0];

                container.innerHTML = `
                    <div class="stat-card"><div class="stat-number">${this.gamificationData.streak.current}</div><div class="stat-label" data-translate-key="stat_streak">${translations[lang].stat_streak}</div></div>
                    <div class="stat-card"><div class="stat-number">${tasksTodayCount}</div><div class="stat-label" data-translate-key="stat_today_tasks">${translations[lang].stat_today_tasks}</div></div>
                    <div class="stat-card"><div class="stat-number">${pomosTodayCount}</div><div class="stat-label" data-translate-key="stat_today_pomos">${translations[lang].stat_today_pomos}</div></div>
                    <div class="stat-card"><div class="stat-number">${avgFocusTime} <small>min</small></div><div class="stat-label" data-translate-key="stat_avg_focus">${translations[lang].stat_avg_focus}</div></div>
                    <div class="stat-card"><div class="stat-number" style="font-size: 1.5rem;">${topCategory ? (translations[lang]['cat_' + topCategory] || topCategory) : '-'}</div><div class="stat-label" data-translate-key="stat_top_category">${translations[lang].stat_top_category}</div></div>
                `;
            }


            async requestNotificationPermission() { if (this.settings.notificationPermission === 'default') { this.settings.notificationPermission = await Notification.requestPermission(); this.saveData('settings', this.settings); }}
            showPushNotification(title, body) { if (this.settings.notificationPermission === 'granted') { const options = { body: body, icon: './icons/android-launchericon-192-192.png', requireInteraction: true }; try { navigator.serviceWorker.getRegistration().then(reg => { if (reg) reg.showNotification(title, options); else new Notification(title, options); }); } catch (e) { new Notification(title, options); } }}
            exportData() { const data = JSON.stringify({ tasks: this.tasks, settings: this.settings, gamification: this.gamificationData }); const blob = new Blob([data], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'taskmaster_backup.json'; a.click(); URL.revokeObjectURL(url); }
            importData(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const data = JSON.parse(e.target.result); if (data.tasks && data.settings) { this.tasks = data.tasks; this.settings = data.settings; if(data.gamification) this.gamificationData = data.gamification; this.saveData('tasks', this.tasks); this.saveData('settings', this.settings); this.saveData('gamification', this.gamificationData); this.applySettings(); this.showToast('feedback_imported'); } else { throw new Error('Invalid file format'); } } catch (error) { this.showToast('feedback_error_import', 'error'); console.error(error); } }; reader.readAsText(file); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.app = new TaskMaster();
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./service-worker.js')
                        .then(reg => console.log('Service Worker: Registrado con √©xito.'))
                        .catch(err => console.error('Service Worker: Fallo en el registro.', err));
                });
            }
        });
    </script>
</body>
</html>
