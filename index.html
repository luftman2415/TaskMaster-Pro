<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskMaster Pro</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" href="./favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="./icons/android-launchericon-192-192.png">
    <meta name="theme-color" content="#667eea">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- NUEVA LIBRERÍA DE GRÁFICOS: Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-grad-start: #667eea; --bg-grad-end: #764ba2;
            --header-grad-start: #4facfe; --header-grad-end: #00f2fe;
            --text-light: white; --text-dark: #2d3748; --text-muted: #64748b;
            --bg-main: rgba(255, 255, 255, 0.95); --bg-secondary: #f8fafc; --bg-card: white;
            --border-color: #e2e8f0; --accent-color: #4facfe;
            --shadow-light: rgba(0, 0, 0, 0.08); --shadow-heavy: rgba(0, 0, 0, 0.1);
            --notification-grad-start: #667eea; --notification-grad-end: #764ba2;
            --pomodoro-active-bg: color-mix(in srgb, var(--accent-color) 15%, transparent);
            --toast-success-bg: #48bb78; --toast-error-bg: #f56565;
            --prio-high: #f56565; --prio-medium: #ed8936; --prio-low: #48bb78;
        }
        [data-theme="dark"] {
            --bg-grad-start: #232526; --bg-grad-end: #414345; --header-grad-start: #434343; --header-grad-end: #000000;
            --text-light: #f7fafc; --text-dark: #e2e8f0; --text-muted: #a0aec0;
            --bg-main: rgba(26, 32, 44, 0.95); --bg-secondary: #2d3748; --bg-card: #4a5568; --border-color: #4a5568;
            --accent-color: #63b3ed; --shadow-light: rgba(255, 255, 255, 0.05); --shadow-heavy: rgba(0, 0, 0, 0.2);
            --notification-grad-start: #89f7fe; --notification-grad-end: #66a6ff;
        }
        [data-theme="ocean"] {
            --bg-grad-start: #00c6ff; --bg-grad-end: #0072ff; --header-grad-start: #0052D4; --header-grad-end: #4364F7;
            --text-dark: #1A202C; --accent-color: #0072ff;
        }
        [data-theme="forest"] {
            --bg-grad-start: #134E5E; --bg-grad-end: #71B280; --header-grad-start: #0f3443; --header-grad-end: #34e89e;
            --text-dark: #f7fafc; --text-muted: #a0aec0; --bg-main: #2d3748e0; --bg-secondary: #4a5568; --bg-card: #2d3748;
            --accent-color: #34e89e;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%); color: var(--text-dark); min-height: 100vh; padding: 20px; transition: background 0.3s ease, color 0.3s ease; }
        .container { max-width: 1200px; margin: 0 auto; background: var(--bg-main); border-radius: 20px; box-shadow: 0 20px 40px var(--shadow-heavy); overflow: hidden; transition: background 0.3s ease; }
        .header { position: relative; background: linear-gradient(135deg, var(--header-grad-start) 0%, var(--header-grad-end) 100%); padding: 30px; text-align: center; color: var(--text-light); transition: filter 0.3s ease; }
        /* Estilos para el nuevo botón del dashboard */
        .header-buttons { position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; }
        .header-btn { background: rgba(255,255,255,.2); color: #fff; border: none; width: 45px; height: 45px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; transition: all .3s ease; display: flex; align-items: center; justify-content: center; }
        .header-btn:hover { background: rgba(255,255,255,.3); transform: rotate(15deg); }
        .main-content { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; padding: 30px; }
        @media (max-width: 992px) { .main-content { grid-template-columns: 1fr; } }
        .task-section, .stats { transition: opacity 0.3s ease, filter 0.3s ease; }
        body.focus-mode .task-section, body.focus-mode .stats, body.focus-mode .header { opacity: 0.1; filter: blur(4px); pointer-events: none; }
        body.focus-mode .sidebar .pomodoro { z-index: 10; transform: scale(1.05); }
        .task-controls { display: flex; gap: 15px; margin-bottom: 20px; }
        .task-controls input, .task-controls select { padding: 12px; border: 2px solid var(--border-color); background-color: var(--bg-secondary); color: var(--text-dark); border-radius: 8px; font-size: 1rem; flex-grow: 1; transition: border-color 0.3s, background-color 0.3s; }
        #tasksList { margin-top: 20px; }
        .task-item { transition: all 0.3s ease; cursor: grab; }
        .task-item.pomodoro-active { background-color: var(--pomodoro-active-bg); border-left-color: var(--accent-color) !important; transform: scale(1.02); }
        .task-item.dragging { opacity: 0.5; background: var(--accent-color); cursor: grabbing; }
        .task-item.task-overdue { border-left-color: var(--prio-high) !important; }
        .task-item.task-due-today { border-left-color: var(--prio-medium) !important; }
        .subtask-list { margin-top: 15px; padding-left: 10px; border-left: 2px solid var(--border-color); }
        .subtask-item { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 8px; font-size: 0.9rem; }
        .subtask-item input[type="checkbox"] { width: 16px; height: 16px; }
        .subtask-item label { flex-grow: 1; display: flex; align-items: center; gap: 10px; margin-bottom: 0; }
        .subtask-item label.completed { text-decoration: line-through; opacity: 0.7; }
        .task-progress { width: 100%; background-color: var(--border-color); border-radius: 4px; height: 6px; margin-top: 10px; overflow: hidden; }
        .progress-bar { background-color: var(--accent-color); height: 100%; border-radius: 4px; transition: width 0.3s ease; }
        h1{font-size:2.5rem}label{font-weight:600;color:var(--text-muted);margin-bottom:5px;display:block;}.form-row,.stats{display:grid}.stats{grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:20px;padding:30px;background:var(--bg-secondary)}.stat-card{background:var(--bg-card);padding:20px;border-radius:15px;text-align:center;box-shadow:0 4px 15px var(--shadow-light);transition:all .3s ease}.stat-card:hover{transform:translateY(-5px)}.stat-number{font-size:2.5rem;font-weight:700;color:var(--accent-color)}.stat-label{color:var(--text-muted);font-size:.9rem}.task-section,.sidebar>div{background:var(--bg-card);border-radius:15px;padding:25px;box-shadow:0 4px 15px var(--shadow-light)}.section-title{font-size:1.5rem;color:var(--text-dark);margin-bottom:20px;padding-bottom:10px;border-bottom:2px solid var(--border-color)}.notification{background:linear-gradient(135deg,var(--notification-grad-start) 0%,var(--notification-grad-end) 100%);color:var(--text-light);padding:15px;border-radius:10px;margin-bottom:10px;text-align:center;font-weight:600;}.task-form{display:grid;gap:15px;margin-bottom:25px}.task-form input[type="text"],.task-form input[type="date"],.task-form select{width:100%;padding:12px;border:2px solid var(--border-color);background-color:var(--bg-secondary);color:var(--text-dark);border-radius:8px;font-size:1rem;transition:border-color .3s,background-color .3s}.task-form input:focus,.task-form select:focus{outline:none;border-color:var(--accent-color)}.form-row{grid-template-columns:1fr 1fr;gap:15px}.time-picker-group{display:flex;gap:8px}.time-picker-group select{flex:1}.form-group{display:flex;flex-direction:column}.form-group.full-width{grid-column:1/-1}.task-item{background:var(--bg-secondary);padding:20px;border-radius:12px;margin-bottom:15px;border-left:5px solid #cbd5e0}.task-item:hover{transform:translateX(5px);box-shadow:0 4px 15px var(--shadow-heavy)}.task-header,.task-actions{display:flex;align-items:flex-start}.task-header{justify-content:space-between;margin-bottom:10px}.task-title{font-size:1.1rem;font-weight:600;color:var(--text-dark);margin-bottom:5px}.task-meta{display:flex;gap:15px;align-items:center;font-size:.9rem;color:var(--text-muted);flex-wrap:wrap}.task-actions{gap:5px}.btn{padding:8px 16px;border:none;border-radius:8px;cursor:pointer;font-weight:600;transition:all .3s ease;font-size:.9rem}.btn-primary{background:linear-gradient(135deg,var(--header-grad-start) 0%,var(--header-grad-end) 100%);color:#fff}.btn-icon{width:35px;height:35px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;background-color:transparent;color:var(--text-muted)}.btn-icon:hover{background-color:var(--border-color)}.sidebar{display:flex;flex-direction:column;gap:25px}.pomodoro-timer{font-size:2.5rem;font-weight:700;text-align:center;color:var(--text-dark);margin:10px 0;transition: color 0.3s;}.pomodoro-timer.finished{animation:blinker 1s linear 3;}.pomodoro-cycle-title{text-align:center;font-weight:600;color:var(--text-muted);margin-bottom:10px}.pomodoro-controls{display:flex;justify-content:center;gap:10px;margin-top:20px}.pomodoro-btn{width:50px;height:50px;border-radius:50%;border:none;font-size:1.2rem;cursor:pointer;color:#fff;transition:all .3s ease;display:flex;align-items:center;justify-content:center}.pomodoro-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px var(--shadow-heavy)}.play-btn{background:#48bb78}.pause-btn{background:#ed8936}.reset-btn{background:#e53e3e}.skip-btn{background:#4facfe}.modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);backdrop-filter:blur(5px);z-index:1000;animation:fadeIn .3s ease}.modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--bg-card);color:var(--text-dark);border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.2);max-width:800px;width:90%;overflow:hidden;animation:slideInModal .3s ease}.modal-header{background:linear-gradient(135deg,#f56565 0%,#e53e3e 100%);color:#fff;padding:20px;text-align:center}.modal-header.settings,.modal-header.edit,.modal-header.dashboard{background:linear-gradient(135deg,var(--header-grad-start) 0%,var(--header-grad-end) 100%)}.modal-body{padding:25px;max-height:70vh;overflow-y:auto}.modal-body p{color:var(--text-muted);font-size:1rem;margin-bottom:25px;line-height:1.5;text-align:center}.modal-actions{display:flex;gap:10px;justify-content:flex-end;padding:20px 25px;border-top:1px solid var(--border-color)}.modal-btn{min-width:100px; padding: 10px 15px;}.completed .task-title{text-decoration:line-through; color: var(--text-muted)}.empty-state{text-align:center;padding:40px;color:var(--text-muted);}.empty-state i{font-size: 4rem; margin-bottom:20px; opacity: 0.5; display: block;}@keyframes fadeIn{from{opacity:0}to{opacity:1}}@keyframes slideInModal{from{opacity:0;transform:translate(-50%,-60%)}to{opacity:1;transform:translate(-50%,-50%)}}
        #editTaskModal .modal { max-width: 500px; }
        .modal-body .form-group select, .modal-body .form-group input, .modal-body .form-group textarea { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--bg-secondary); color: var(--text-dark); }
        .modal-body .form-group textarea { resize: vertical; min-height: 100px; }
        .modal-data-actions { display: flex; gap: 10px; margin-top: 10px; }
        .modal-data-actions .modal-btn, .modal-data-actions .import-label { flex: 1; text-align: center; display: flex; align-items: center; justify-content: center; background-color: var(--bg-secondary); color: var(--text-dark); border: 1px solid var(--border-color); }
        .modal-data-actions .import-label { cursor: pointer; }
        .modal-data-actions .modal-btn:hover, .modal-data-actions .import-label:hover { background-color: var(--border-color); }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--toast-success-bg); color: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s, bottom 0.3s; }
        .toast.show { opacity: 1; visibility: visible; bottom: 40px; }
        .toast.error { background-color: var(--toast-error-bg); }
        .chart-container { margin-bottom: 40px; }
        .chart-container h4 { text-align: center; color: var(--text-dark); margin-bottom: 15px; }
        @keyframes blinker { 50% { opacity: 0.2; } }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1 data-translate-key="title">🎯 TaskMaster Pro</h1>
            <p data-translate-key="subtitle">Organiza tu día con inteligencia</p>
            <div class="header-buttons">
                <!-- NUEVO BOTÓN PARA EL DASHBOARD -->
                <button id="dashboardBtn" class="header-btn" title="Dashboard de Productividad"><i class="fa-solid fa-chart-line"></i></button>
                <button id="settingsBtn" class="header-btn" title="Configuración"><i class="fa-solid fa-gear"></i></button>
            </div>
        </div>

        <!-- STATS -->
        <div class="stats" id="statsContainer"></div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <div class="task-section">
                <!-- ADD TASK FORM -->
                <div id="taskFormContainer"></div>

                <!-- TASK CONTROLS (SEARCH AND FILTER) -->
                <div class="task-controls">
                    <input type="search" id="searchInput" data-translate-key-placeholder="placeholder_search">
                    <select id="filterCategory"></select>
                </div>
                
                <!-- TASK LIST -->
                <div id="tasksList"></div>
            </div>

            <!-- SIDEBAR -->
            <div class="sidebar">
                <div class="notifications">
                    <h3 class="section-title" data-translate-key="title_notifications">🔔 Notificaciones</h3>
                    <div id="welcomeNotification" class="notification"></div>
                </div>
                <div class="pomodoro">
                    <h3 class="section-title" data-translate-key="title_pomodoro">🍅 Pomodoro</h3>
                    <div id="pomodoroTaskTitle" style="text-align: center; color: var(--text-muted); margin-bottom: 10px; font-weight: 500; min-height: 20px;"></div>
                    <div id="pomodoroCycleTitle" class="pomodoro-cycle-title"></div>
                    <div id="pomodoroTimer" class="pomodoro-timer">25:00</div>
                    <div class="pomodoro-controls">
                        <button class="pomodoro-btn play-btn" id="playBtn" title="Iniciar"><i class="fa-solid fa-play"></i></button>
                        <button class="pomodoro-btn pause-btn" id="pauseBtn" title="Pausar"><i class="fa-solid fa-pause"></i></button>
                        <button class="pomodoro-btn reset-btn" id="resetBtn" title="Reiniciar"><i class="fa-solid fa-stop"></i></button>
                        <button class="pomodoro-btn skip-btn" id="skipBtn" title="Saltar"><i class="fa-solid fa-forward"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODALS -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <div class="modal-header"><h3></h3></div>
            <div class="modal-body"><p></p></div>
            <div class="modal-actions">
                <button id="cancelDelete" class="modal-btn"></button>
                <button id="confirmDelete" class="modal-btn" style="background-color: #e53e3e; color: white;"></button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="editTaskModal">
        <div class="modal">
            <div class="modal-header edit"><h3></h3></div>
            <div class="modal-body">
                <div class="form-group">
                    <label data-translate-key="label_task"></label>
                    <input type="text" id="editTaskTitle">
                </div>
                <div class="form-group">
                    <label data-translate-key="label_notes"></label>
                    <textarea id="editTaskNotes" data-translate-key-placeholder="placeholder_notes"></textarea>
                </div>
                <div class="form-group">
                    <label data-translate-key="label_subtasks"></label>
                    <div id="editSubtaskList"></div>
                    <input type="text" id="newSubtaskInput">
                </div>
            </div>
            <div class="modal-actions">
                <button id="cancelEdit" class="modal-btn"></button>
                <button id="saveEdit" class="modal-btn" style="background-color: var(--accent-color); color: white;"></button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="settingsModal">
         <div class="modal" style="max-width: 500px;">
            <div class="modal-header settings"><h3></h3></div>
            <div class="modal-body" style="text-align: left;">
                <div class="form-group">
                    <label for="themeSelector" data-translate-key="settings_theme"></label>
                    <select id="themeSelector">
                        <option value="light" data-translate-key="theme_light"></option>
                        <option value="dark" data-translate-key="theme_dark"></option>
                        <option value="ocean" data-translate-key="theme_ocean"></option>
                        <option value="forest" data-translate-key="theme_forest"></option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="languageSelector" data-translate-key="settings_language"></label>
                    <select id="languageSelector"><option value="es">Español</option><option value="en">English</option></select>
                </div>
                <div style="border-top: 1px solid var(--border-color); padding-top: 15px; margin-top: 10px;">
                    <h4 data-translate-key="settings_pomodoro"></h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="pomodoroWork" data-translate-key="pomo_work_duration"></label>
                            <input type="number" id="pomodoroWork" min="1">
                        </div>
                        <div class="form-group">
                             <label for="pomodoroShortBreak" data-translate-key="pomo_short_break_duration"></label>
                            <input type="number" id="pomodoroShortBreak" min="1">
                        </div>
                    </div>
                     <div class="form-group">
                        <label for="pomodoroLongBreak" data-translate-key="pomo_long_break_duration"></label>
                        <input type="number" id="pomodoroLongBreak" min="1">
                    </div>
                </div>
                <div style="border-top: 1px solid var(--border-color); padding-top: 15px; margin-top: 10px;">
                    <label data-translate-key="settings_data"></label>
                    <div class="modal-data-actions">
                        <button id="exportBtn" class="modal-btn"><i class="fa-solid fa-file-export"></i> <span data-translate-key="btn_export"></span></button>
                        <label for="importFile" class="modal-btn import-label"><i class="fa-solid fa-file-import"></i> <span data-translate-key="btn_import"></span></label>
                        <input type="file" id="importFile" accept=".json" style="display: none;">
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button id="closeSettings" class="modal-btn btn-primary" data-translate-key="btn_close"></button>
            </div>
        </div>
    </div>
    <!-- NUEVO MODAL PARA EL DASHBOARD -->
    <div class="modal-overlay" id="dashboardModal">
         <div class="modal">
            <div class="modal-header dashboard"><h3 data-translate-key="dashboard_title"></h3></div>
            <div class="modal-body">
                <div class="chart-container">
                    <h4 data-translate-key="dashboard_weekly_title"></h4>
                    <canvas id="completedTasksChart"></canvas>
                </div>
                <div class="chart-container">
                     <h4 data-translate-key="dashboard_category_title"></h4>
                    <canvas id="categoryDistributionChart"></canvas>
                </div>
                 <div class="chart-container">
                     <h4 data-translate-key="dashboard_pomodoro_title"></h4>
                    <canvas id="pomodoroPerformanceChart"></canvas>
                </div>
            </div>
            <div class="modal-actions">
                <button id="closeDashboard" class="modal-btn btn-primary" data-translate-key="btn_close"></button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Notification Sound -->
    <audio id="notificationSound" src="https://assets.mixkit.co/sfx/preview/mixkit-positive-notification-951.mp3" preload="auto"></audio>

    <script>
        const translations = {
            es: { title: "🎯 TaskMaster Pro", subtitle: "Organiza tu día con inteligencia", stat_total: "Total", stat_completed: "Completadas", stat_pending: "Pendientes", stat_overdue: "Vencidas", form_title: "¿Qué necesitas hacer hoy?", label_task: "Tarea", placeholder_task: "Ej: Diseñar el nuevo logo", label_category: "Categoría", cat_work: "💼 Trabajo", cat_personal: "👤 Personal", cat_health: "🏃 Salud", cat_study: "📚 Estudio", cat_other: "📋 Otros", label_priority: "Prioridad", prio_low: "🟢 Baja", prio_medium: "🟡 Media", prio_high: "🔴 Alta", label_date: "Fecha Límite", label_time: "Hora", btn_add_task: "➕ Agregar Tarea", placeholder_search: "Buscar tareas...", filter_all: "Todas las categorías", empty_state_title: "¡Todo despejado!", empty_state_text: "Agrega una nueva tarea para empezar.", title_notifications: "🔔 Notificaciones", welcome_notification: "¡Bienvenido a TaskMaster Pro! 🎉", title_pomodoro: "🍅 Pomodoro", delete_modal_title: "⚠️ Confirmar eliminación", delete_modal_text: "¿Estás seguro de que quieres eliminar esta tarea?", btn_delete: "Eliminar", btn_cancel: "Cancelar", edit_modal_title: "✏️ Editar Tarea", label_subtasks: "Sub-tareas", placeholder_subtask: "Añadir sub-tarea y presionar Enter", settings_title: "⚙️ Configuración", settings_theme: "Tema", theme_light: "Claro", theme_dark: "Oscuro", theme_ocean: "Océano", theme_forest: "Bosque", settings_language: "Idioma", settings_data: "Datos de la Aplicación", btn_export: "Exportar", btn_import: "Importar", btn_save_changes: "Guardar", btn_close: "Cerrar", feedback_imported: "¡Datos importados con éxito!", feedback_error_import: "Error al importar el archivo.", toast_task_added: "Tarea agregada con éxito", toast_task_deleted: "Tarea eliminada", toast_task_updated: "Tarea actualizada", settings_pomodoro: "Personalización de Pomodoro", pomo_work_duration: "Trabajo (min)", pomo_short_break_duration: "Descanso Corto (min)", pomo_long_break_duration: "Descanso Largo (min)", pomo_cycle_work: "¡A trabajar!", pomo_cycle_short: "Descanso corto", pomo_cycle_long: "Descanso largo", notification_title: "¡Tiempo!", notification_work_end: "¡Buen trabajo! Es hora de un descanso.", notification_break_end: "El descanso terminó. ¡De vuelta al trabajo!", label_recurrence: "Recurrencia", recur_none: "Ninguna", recur_daily: "Diaria", recur_weekly: "Semanal", pomo_task_title_prefix: "Enfocado en: ", label_notes: "Notas Adicionales", placeholder_notes: "Añade detalles, enlaces, etc.", dashboard_title: "📊 Dashboard de Productividad", dashboard_weekly_title: "Tareas Completadas (Últimos 7 Días)", dashboard_category_title: "Distribución por Categoría", dashboard_pomodoro_title: "Rendimiento de Pomodoros", day_sun: "Dom", day_mon: "Lun", day_tue: "Mar", day_wed: "Mié", day_thu: "Jue", day_fri: "Vie", day_sat: "Sáb"},
            en: { title: "🎯 TaskMaster Pro", subtitle: "Organize your day with intelligence", stat_total: "Total", stat_completed: "Completed", stat_pending: "Pending", stat_overdue: "Overdue", form_title: "What do you need to do today?", label_task: "Task", placeholder_task: "E.g.: Design the new logo", label_category: "Category", cat_work: "💼 Work", cat_personal: "👤 Personal", cat_health: "🏃 Health", cat_study: "📚 Study", cat_other: "📋 Other", label_priority: "Priority", prio_low: "🟢 Low", prio_medium: "🟡 Medium", prio_high: "🔴 High", label_date: "Due Date", label_time: "Time", btn_add_task: "➕ Add Task", placeholder_search: "Search tasks...", filter_all: "All categories", empty_state_title: "All clear!", empty_state_text: "Add a new task to get started.", title_notifications: "🔔 Notifications", welcome_notification: "Welcome to TaskMaster Pro! 🎉", title_pomodoro: "🍅 Pomodoro", delete_modal_title: "⚠️ Confirm Deletion", delete_modal_text: "Are you sure you want to delete this task?", btn_delete: "Delete", btn_cancel: "Cancel", edit_modal_title: "✏️ Edit Task", label_subtasks: "Sub-tasks", placeholder_subtask: "Add sub-task and press Enter", settings_title: "⚙️ Settings", settings_theme: "Theme", theme_light: "Light", theme_dark: "Dark", theme_ocean: "Ocean", theme_forest: "Forest", settings_language: "Language", settings_data: "Application Data", btn_export: "Export", btn_import: "Import", btn_save_changes: "Save", btn_close: "Close", feedback_imported: "Data imported successfully!", feedback_error_import: "Error importing file.", toast_task_added: "Task added successfully", toast_task_deleted: "Task deleted", toast_task_updated: "Task updated", settings_pomodoro: "Pomodoro Customization", pomo_work_duration: "Work (min)", pomo_short_break_duration: "Short Break (min)", pomo_long_break_duration: "Long Break (min)", pomo_cycle_work: "Time to work!", pomo_cycle_short: "Short break", pomo_cycle_long: "Long break", notification_title: "Time's Up!", notification_work_end: "Good job! Time for a break.", notification_break_end: "Break's over. Back to work!", label_recurrence: "Recurrence", recur_none: "None", recur_daily: "Daily", recur_weekly: "Weekly", pomo_task_title_prefix: "Focused on: ", label_notes: "Additional Notes", placeholder_notes: "Add details, links, etc.", dashboard_title: "📊 Productivity Dashboard", dashboard_weekly_title: "Tasks Completed (Last 7 Days)", dashboard_category_title: "Distribution by Category", dashboard_pomodoro_title: "Pomodoro Performance", day_sun: "Sun", day_mon: "Mon", day_tue: "Tue", day_wed: "Wed", day_thu: "Thu", day_fri: "Fri", day_sat: "Sat"}
        };

        class TaskMaster {
            constructor() {
                const defaultSettings = { 
                    theme: 'light', 
                    language: 'es',
                    pomodoro: { work: 25, short: 5, long: 15, cycles: 0 },
                    notificationPermission: 'default'
                };
                this.tasks = this.loadData('tasks', []);
                this.settings = { ...defaultSettings, ...this.loadData('settings', {}) };

                this.currentPomodoroTask = null;
                this.pomodoroInterval = null;
                this.isPomodoroRunning = false;
                this.pomodoroState = { type: 'work', time: this.settings.pomodoro.work * 60 };
                
                this.currentEditingTask = null;
                this.draggedTaskElement = null;
                this.charts = {}; // Para almacenar instancias de gráficos

                this.applySettings();
                this.initializeEventListeners();
            }

            // --- DATA & SETTINGS ---
            loadData(key, defaultValue) { try { const data = localStorage.getItem(`taskmaster-${key}`); return data ? JSON.parse(data) : defaultValue; } catch (e) { console.error(`Error loading data for key: ${key}`, e); return defaultValue; } }
            saveData(key, data) { localStorage.setItem(`taskmaster-${key}`, JSON.stringify(data)); }
            applySettings() {
                document.documentElement.setAttribute('data-theme', this.settings.theme);
                document.documentElement.lang = this.settings.language;
                document.getElementById('themeSelector').value = this.settings.theme;
                document.getElementById('languageSelector').value = this.settings.language;
                document.getElementById('pomodoroWork').value = this.settings.pomodoro.work;
                document.getElementById('pomodoroShortBreak').value = this.settings.pomodoro.short;
                document.getElementById('pomodoroLongBreak').value = this.settings.pomodoro.long;
                this.renderAll();
            }

            // --- UI FEEDBACK ---
            showToast(messageKey, type = 'success') {
                const toast = document.getElementById('toast');
                toast.textContent = translations[this.settings.language][messageKey] || messageKey;
                toast.className = `toast ${type} show`;
                setTimeout(() => { toast.className = 'toast'; }, 3000);
            }
            showModal(id) { document.getElementById(id).style.display = 'block'; }
            hideModal(id) { document.getElementById(id).style.display = 'none'; }

            // --- CORE RENDERING ---
            renderAll() {
                const lang = this.settings.language;
                // Translation logic for data-translate-key
                document.querySelectorAll('[data-translate-key]').forEach(el => {
                    const key = el.getAttribute('data-translate-key');
                    const translation = translations[lang]?.[key];
                    if (translation) {
                        if (el.tagName === 'SPAN' || el.parentElement?.tagName === 'LABEL' || el.parentElement?.tagName === 'BUTTON') {
                            el.textContent = translation;
                        } else {
                            el.innerHTML = translation;
                        }
                    }
                });
                // Translation logic for placeholders
                document.querySelectorAll('[data-translate-key-placeholder]').forEach(el => {
                    const key = el.getAttribute('data-translate-key-placeholder');
                    if (translations[lang]?.[key]) el.placeholder = translations[lang][key];
                });
                
                this.renderStats();
                this.renderTaskForm();
                this.renderFilterOptions();
                this.renderTasks();
                this.checkWelcomeNotification();
                this.updatePomodoroDisplay();
            }

            renderStats() { /* ... sin cambios ... */ }
            renderTaskForm() { /* ... sin cambios ... */ }
            renderFilterOptions() { /* ... sin cambios ... */ }
            renderTasks() { /* ... sin cambios ... */ }
            createTaskElement(task) { /* ... sin cambios ... */ }
            checkWelcomeNotification() { /* ... sin cambios ... */ }
            
            // --- EVENT LISTENERS ---
            initializeEventListeners() {
                // ... (otros listeners sin cambios)
                document.getElementById('searchInput').addEventListener('input', () => this.renderTasks());
                document.getElementById('filterCategory').addEventListener('change', () => this.renderTasks());
                
                // Header Buttons
                document.getElementById('dashboardBtn').addEventListener('click', () => this.showDashboard());
                document.getElementById('settingsBtn').addEventListener('click', () => this.showModal('settingsModal'));
                
                // Modals Close Buttons
                document.getElementById('closeDashboard').addEventListener('click', () => this.hideModal('dashboardModal'));
                document.getElementById('closeSettings').addEventListener('click', () => { this.hideModal('settingsModal'); this.renderAll(); });
                
                document.getElementById('themeSelector').addEventListener('change', (e) => { this.settings.theme = e.target.value; this.saveData('settings', this.settings); this.applySettings(); });
                document.getElementById('languageSelector').addEventListener('change', (e) => { this.settings.language = e.target.value; this.saveData('settings', this.settings); this.applySettings(); });
                document.getElementById('exportBtn').addEventListener('click', this.exportData.bind(this));
                document.getElementById('importFile').addEventListener('change', this.importData.bind(this));
                
                document.getElementById('playBtn').addEventListener('click', () => this.startPomodoro());
                document.getElementById('pauseBtn').addEventListener('click', () => this.pausePomodoro());
                document.getElementById('resetBtn').addEventListener('click', () => this.resetPomodoro(true));
                document.getElementById('skipBtn').addEventListener('click', () => this.nextPomodoroCycle(true));
                document.getElementById('pomodoroWork').addEventListener('change', (e) => this.updatePomodoroSetting('work', e.target.value));
                document.getElementById('pomodoroShortBreak').addEventListener('change', (e) => this.updatePomodoroSetting('short', e.target.value));
                document.getElementById('pomodoroLongBreak').addEventListener('change', (e) => this.updatePomodoroSetting('long', e.target.value));
                
                const tasksList = document.getElementById('tasksList');
                tasksList.addEventListener('click', this.handleTaskListClick.bind(this));
                tasksList.addEventListener('dragstart', this.handleDragStart.bind(this));
                tasksList.addEventListener('dragover', this.handleDragOver.bind(this));
                tasksList.addEventListener('drop', this.handleDrop.bind(this));
                
                document.getElementById('cancelDelete').addEventListener('click', () => this.hideModal('deleteModal'));
                document.getElementById('cancelEdit').addEventListener('click', () => this.hideModal('editTaskModal'));
                document.getElementById('saveEdit').addEventListener('click', () => this.saveEditedTask());
                document.getElementById('newSubtaskInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') { e.preventDefault(); this.addSubtask(); }});
                document.getElementById('editSubtaskList').addEventListener('click', (e) => { if(e.target.closest('.delete-subtask-btn')) this.deleteSubtask(e.target.closest('.delete-subtask-btn').dataset.subtaskId); });
            }
            
            handleTaskListClick(e) { /* ... sin cambios ... */ }

            // --- TASK ACTIONS ---
            handleAddTask(e) {
                e.preventDefault();
                const form = e.target;
                this.tasks.unshift({
                    id: `task-${Date.now()}`,
                    title: new FormData(form).get('title').trim(),
                    category: new FormData(form).get('category'),
                    priority: new FormData(form).get('priority'),
                    recurrence: new FormData(form).get('recurrence'),
                    date: new FormData(form).get('date') || null,
                    completed: false,
                    completedAt: null, // NUEVO: para tracking de fecha
                    pomodorosCompleted: 0, // NUEVO: para tracking de pomodoros
                    subtasks: [],
                    notes: ''
                });
                this.saveData('tasks', this.tasks);
                document.getElementById('filterCategory').value = 'all';
                this.renderAll();
                form.reset();
                this.showToast('toast_task_added');
            }

            toggleTaskCompletion(taskId) {
                const task = this.tasks.find(t => t.id === taskId);
                if(!task) return;
                task.completed = !task.completed;
                // NUEVO: Añadir/quitar fecha de completado
                task.completedAt = task.completed ? Date.now() : null;

                if (task.completed && task.recurrence !== 'none' && task.date) {
                    const newTask = { ...task, id: `task-${Date.now()}`, completed: false, completedAt: null, subtasks: task.subtasks.map(st => ({...st, completed: false})) };
                    const newDate = new Date(task.date + 'T00:00:00');
                    if(task.recurrence === 'daily') newDate.setDate(newDate.getDate() + 1);
                    if(task.recurrence === 'weekly') newDate.setDate(newDate.getDate() + 7);
                    newTask.date = newDate.toISOString().split('T')[0];
                    this.tasks.push(newTask);
                    this.tasks.sort((a,b) => (a.date > b.date) ? 1 : -1);
                }
                
                this.saveData('tasks', this.tasks);
                this.renderAll();
                this.showToast('toast_task_updated');
            }
            
            showDeleteModal(taskId) { /* ... sin cambios ... */ }
            showEditModal(taskId) { /* ... sin cambios ... */ }
            saveEditedTask() { /* ... sin cambios ... */ }
            renderSubtasks() { /* ... sin cambios ... */ }
            addSubtask() { /* ... sin cambios ... */ }
            toggleSubtask(subtaskId) { /* ... sin cambios ... */ }
            deleteSubtask(subtaskId) { /* ... sin cambios ... */ }
            handleDragStart(e) { /* ... sin cambios ... */ }
            handleDragOver(e) { /* ... sin cambios ... */ }
            handleDrop(e) { /* ... sin cambios ... */ }

            // --- POMODORO LOGIC ---
            updatePomodoroSetting(key, value) { /* ... sin cambios ... */ }
            startPomodoroForTask(taskId) { /* ... sin cambios ... */ }
            startPomodoro() { /* ... sin cambios ... */ }
            pausePomodoro() { /* ... sin cambios ... */ }
            resetPomodoro(fullReset) { /* ... sin cambios ... */ }
            
            finishPomodoroCycle() {
                const timerEl = document.getElementById('pomodoroTimer');
                timerEl.classList.add('finished');
                document.getElementById('notificationSound').play();
                
                // NUEVO: Tracking de pomodoros completados
                if(this.pomodoroState.type === 'work' && this.currentPomodoroTask) {
                    const task = this.tasks.find(t => t.id === this.currentPomodoroTask);
                    if(task) {
                        task.pomodorosCompleted = (task.pomodorosCompleted || 0) + 1;
                        this.saveData('tasks', this.tasks);
                    }
                }
                
                const lang = this.settings.language;
                this.showPushNotification(
                    translations[lang].notification_title,
                    this.pomodoroState.type === 'work' ? translations[lang].notification_work_end : translations[lang].notification_break_end
                );

                setTimeout(() => {
                    timerEl.classList.remove('finished');
                    this.nextPomodoroCycle(false);
                }, 3000);
            }

            nextPomodoroCycle(isSkip) { /* ... sin cambios ... */ }
            updatePomodoroDisplay() { /* ... sin cambios ... */ }

            // --- DASHBOARD & CHARTS LOGIC ---
            showDashboard() {
                this.showModal('dashboardModal');
                // Retrasar la renderización de los gráficos para asegurar que el modal es visible
                setTimeout(() => {
                    this.renderWeeklyChart();
                    this.renderCategoryChart();
                    this.renderPomodoroChart();
                }, 100);
            }

            renderChart(canvasId, type, data, options = {}) {
                if (this.charts[canvasId]) {
                    this.charts[canvasId].destroy();
                }
                const ctx = document.getElementById(canvasId).getContext('2d');
                this.charts[canvasId] = new Chart(ctx, { type, data, options });
            }

            renderWeeklyChart() {
                const lang = this.settings.language;
                const labels = [];
                const data = [0, 0, 0, 0, 0, 0, 0];
                const dayKeys = ['day_sun', 'day_mon', 'day_tue', 'day_wed', 'day_thu', 'day_fri', 'day_sat'];
                
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    labels.push(translations[lang][dayKeys[date.getDay()]]);
                }
                
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

                this.tasks.filter(t => t.completed && t.completedAt && new Date(t.completedAt) > sevenDaysAgo)
                    .forEach(task => {
                        const completedDate = new Date(task.completedAt);
                        const diffDays = Math.floor((new Date() - completedDate) / (1000 * 60 * 60 * 24));
                        if(diffDays < 7) {
                            data[6 - diffDays]++;
                        }
                    });

                this.renderChart('completedTasksChart', 'bar', {
                    labels,
                    datasets: [{
                        label: translations[lang].stat_completed,
                        data,
                        backgroundColor: 'rgba(79, 172, 254, 0.5)',
                        borderColor: 'rgba(79, 172, 254, 1)',
                        borderWidth: 1
                    }]
                }, { responsive: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } });
            }

            renderCategoryChart() {
                const lang = this.settings.language;
                const categoryCounts = this.tasks.reduce((acc, task) => {
                    acc[task.category] = (acc[task.category] || 0) + 1;
                    return acc;
                }, {});

                const labels = Object.keys(categoryCounts).map(cat => translations[lang]['cat_' + cat] || cat);
                const data = Object.values(categoryCounts);

                this.renderChart('categoryDistributionChart', 'doughnut', {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'],
                    }]
                }, { responsive: true });
            }
            
            renderPomodoroChart() {
                const lang = this.settings.language;
                const pomodoroTasks = this.tasks
                    .filter(t => t.pomodorosCompleted > 0)
                    .sort((a,b) => b.pomodorosCompleted - a.pomodorosCompleted)
                    .slice(0, 7); // Mostrar solo las 7 tareas con más pomodoros

                const labels = pomodoroTasks.map(t => t.title.length > 25 ? t.title.substring(0, 22) + '...' : t.title);
                const data = pomodoroTasks.map(t => t.pomodorosCompleted);

                this.renderChart('pomodoroPerformanceChart', 'bar', {
                    labels,
                    datasets: [{
                        label: 'Pomodoros',
                        data,
                        backgroundColor: 'rgba(255, 159, 64, 0.5)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1
                    }]
                }, { responsive: true, indexAxis: 'y' });
            }

            // --- NOTIFICATIONS & DATA (sin cambios) ---
            async requestNotificationPermission() { /* ... sin cambios ... */ }
            showPushNotification(title, body) { /* ... sin cambios ... */ }
            exportData() { /* ... sin cambios ... */ }
            importData(event) { /* ... sin cambios ... */ }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.app = new TaskMaster();
            
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('Service Worker: Registrado exitosamente', reg))
                    .catch(err => console.log('Service Worker: Fallo en el registro', err));
            }
        });
    </script>
</body>
</html>
